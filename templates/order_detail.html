{% extends "base.html" %}

{% block title %}Order Details - Locus Assistant{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-6">
        <h2>
            <i class="fas fa-box me-2"></i>Order {{ order_id }} Details
        </h2>
    </div>
    <div class="col-md-6 text-end">
        <!-- Dynamic Validation Button -->
        {% if order.has_grn %}
            {% if order.validation_summary and order.validation_summary.has_validation %}
                <button class="btn btn-warning me-2" id="reprocess-order-btn" data-order-id="{{ order_id }}" data-date="{{ date }}">
                    <i class="fas fa-redo me-1"></i>Re-process GRN
                </button>
            {% else %}
                <button class="btn btn-success me-2" id="validate-order-btn" data-order-id="{{ order_id }}" data-date="{{ date }}">
                    <i class="fas fa-check-circle me-1"></i>Validate GRN
                </button>
            {% endif %}
        {% else %}
            <span class="badge bg-secondary me-2 px-3 py-2">
                <i class="fas fa-info-circle me-1"></i>No GRN Document Available
            </span>
        {% endif %}

        <button class="btn btn-primary me-2" id="edit-order-btn" onclick="toggleOrderEdit()">
            <i class="fas fa-edit"></i>
            Edit Order
        </button>
        <a href="{{ url_for('dashboard', date=date) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Data Source Indicator -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert {{ 'alert-success' if order._from_database else 'alert-info' }} alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-{{ 'database' if order._from_database else 'cloud' }} me-2"></i>
                <div>
                    <strong>Data Source:</strong> {{ order._data_source }}
                    {% if order._from_database %}
                        <br><small class="opacity-75">This order data is enhanced with information stored in our database.</small>
                    {% else %}
                        <br><small class="opacity-75">This order was fetched directly from Locus API and has been saved to our database for future reference.</small>
                    {% endif %}
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<!-- Validation Status Section -->
<div class="row mb-3">
    <div class="col-12">
        <div id="validation-status" class="validation-status" style="display: none;">
            <!-- Validation results will be displayed here -->
        </div>

        <!-- Show existing validation results if available -->
        {% if order.validation_summary and order.validation_summary.has_validation %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>
                    GRN Validation Results
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        {% if order.validation_summary.is_valid %}
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>Validation Successful</h6>
                                <p class="mb-0">The GRN document matches the order data perfectly.</p>
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Validation Issues Found</h6>
                                <p class="mb-1">{{ order.validation_summary.discrepancies_count }} discrepancies detected.</p>
                                {% if order.validation_summary.summary %}
                                    <small>Expected {{ order.validation_summary.summary.total_items_expected or 'N/A' }} items, found {{ order.validation_summary.summary.total_items_found or 'N/A' }}</small>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="validation-metrics-detail">
                            <div class="row">
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value">{{ "%.0f"|format(order.validation_summary.confidence_score * 100) }}%</div>
                                        <div class="metric-label">Confidence</div>
                                    </div>
                                </div>
                                {% if order.validation_summary.gtins_verified %}
                                <div class="col-6">
                                    <div class="metric-card">
                                        <div class="metric-value">{{ order.validation_summary.gtins_matched }}/{{ order.validation_summary.gtins_verified }}</div>
                                        <div class="metric-label">GTINs Matched</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if order.validation_summary.has_document is defined and order.validation_summary.has_document == false %}
                    <div class="alert alert-warning">
                        <i class="fas fa-file-times me-2"></i>No document detected in GRN image
                    </div>
                {% endif %}

                <!-- Detailed SKU-Level Validation Results -->
                {% if order.validation_summary.discrepancies and order.validation_summary.discrepancies|length > 0 %}
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                        Detailed Issues Found ({{ order.validation_summary.discrepancies|length }})
                    </h6>

                    <div class="row">
                        {% for discrepancy in order.validation_summary.discrepancies %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-left-{{ 'danger' if discrepancy.severity == 'HIGH' else ('warning' if discrepancy.severity == 'MEDIUM' else 'info') }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <span class="badge bg-{{ 'danger' if discrepancy.severity == 'HIGH' else ('warning' if discrepancy.severity == 'MEDIUM' else 'info') }}">
                                                    {{ discrepancy.type.replace('_', ' ').title() }}
                                                </span>
                                            </h6>
                                            <p class="mb-2">{{ discrepancy.description }}</p>

                                            {% if discrepancy.sku_id %}
                                            <div class="mt-2">
                                                <small class="text-muted d-block"><i class="fas fa-barcode me-1"></i><strong>SKU:</strong> {{ discrepancy.sku_id }}</small>
                                            </div>
                                            {% endif %}

                                            {% if discrepancy.expected and discrepancy.actual %}
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clipboard-list me-1"></i><strong>Expected:</strong><br>
                                                        <span class="text-dark">{{ discrepancy.expected }}</span>
                                                    </small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-file-invoice me-1"></i><strong>Found in GRN:</strong><br>
                                                        <span class="text-dark">{{ discrepancy.actual }}</span>
                                                    </small>
                                                </div>
                                            </div>
                                            {% endif %}

                                            {% if discrepancy.gtin %}
                                            <div class="mt-2">
                                                <small class="text-muted d-block"><i class="fas fa-qrcode me-1"></i><strong>GTIN:</strong> {{ discrepancy.gtin }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Extracted Items from GRN -->
                {% if order.validation_summary.extracted_items and order.validation_summary.extracted_items|length > 0 %}
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-list-ul me-2 text-info"></i>
                        Items Found in GRN Document ({{ order.validation_summary.extracted_items|length }})
                    </h6>

                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Product Name</th>
                                    <th>SKU/Code</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>GTIN</th>
                                    <th>Match Status</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.validation_summary.extracted_items %}
                                <tr class="{% if item.status == 'MATCHED' %}table-success{% elif item.status == 'EXTRA' %}table-warning{% else %}table-danger{% endif %}">
                                    <td>
                                        <strong>{{ item.extracted_name or 'N/A' }}</strong>
                                        {% if item.package_config %}
                                            <br><small class="text-muted">Config: {{ item.package_config }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.extracted_sku %}
                                            <code>{{ item.extracted_sku }}</code>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                        {% if item.matched_order_sku and item.matched_order_sku != item.extracted_sku %}
                                            <br><small class="text-info">→ {{ item.matched_order_sku }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ item.extracted_quantity or 'N/A' }}</strong>
                                        {% if item.quantity_equivalent and item.quantity_equivalent != item.extracted_quantity %}
                                            <br><small class="text-muted">Equiv: {{ item.quantity_equivalent }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.extracted_unit or 'N/A' }}</td>
                                    <td>
                                        {% if item.extracted_gtin %}
                                            <code class="small">{{ item.extracted_gtin }}</code>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if item.status == 'MATCHED' %}success{% elif item.status == 'EXTRA' %}warning{% else %}danger{% endif %}">
                                            {{ item.status }}
                                        </span>
                                        {% if item.match_method %}
                                            <br><small class="text-muted">{{ item.match_method.replace('_', ' ') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.match_confidence %}
                                            <span class="badge bg-{% if item.match_confidence > 0.8 %}success{% elif item.match_confidence > 0.6 %}warning{% else %}danger{% endif %}">
                                                {{ "%.0f"|format(item.match_confidence * 100) }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- GTIN Verification Results -->
                {% if order.validation_summary.gtin_verification and order.validation_summary.gtin_verification|length > 0 %}
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-qrcode me-2 text-success"></i>
                        GTIN Verification Results ({{ order.validation_summary.gtin_verification|length }})
                    </h6>

                    <div class="row">
                        {% for gtin_result in order.validation_summary.gtin_verification %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="mb-2">
                                        <code>{{ gtin_result.gtin }}</code>
                                        <span class="badge bg-{% if gtin_result.verified %}success{% else %}danger{% endif %} ms-2">
                                            {% if gtin_result.verified %}Verified{% else %}Not Found{% endif %}
                                        </span>
                                    </h6>

                                    {% if gtin_result.verified and gtin_result.product_details %}
                                        <div class="mt-2">
                                            <p class="mb-1"><strong>{{ gtin_result.product_details.name or 'N/A' }}</strong></p>
                                            <small class="text-muted">
                                                {% if gtin_result.product_details.brand %}Brand: {{ gtin_result.product_details.brand }}<br>{% endif %}
                                                {% if gtin_result.product_details.category %}Category: {{ gtin_result.product_details.category }}<br>{% endif %}
                                                {% if gtin_result.product_details.manufacturer %}Manufacturer: {{ gtin_result.product_details.manufacturer }}{% endif %}
                                            </small>
                                        </div>
                                    {% endif %}

                                    {% if gtin_result.extracted_item_name %}
                                        <div class="mt-2">
                                            <small class="text-info">
                                                <i class="fas fa-link me-1"></i>Linked to: {{ gtin_result.extracted_item_name }}
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Processed: {{ order.validation_summary.validation_date.split('T')[0] if order.validation_summary.validation_date else 'N/A' }}
                            at {{ order.validation_summary.validation_date.split('T')[1].split('.')[0] if order.validation_summary.validation_date else 'N/A' }}
                            (Processing time: {{ "%.2f"|format(order.validation_summary.processing_time) }}s)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% elif order.has_grn %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>GRN Available</strong> - Click "Validate GRN" above to process the document with AI validation.
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Order Information
                    </h5>
                    {% set current_status = order.effective_status or order.orderStatus or order.order_status %}
                    <span class="badge {{ 'bg-danger' if current_status == 'CANCELLED' else 'bg-success' if current_status == 'COMPLETED' else 'bg-warning' if current_status in ['EXECUTING', 'ONGOING'] else 'bg-secondary' }} text-white">{{ current_status }}</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Order Status and Basic Info -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="info-item editable-field" data-field="order_status">
                            <label>Status:</label>
                            <span class="display-value">
                                <span class="badge {{ 'bg-danger' if current_status == 'CANCELLED' else 'bg-success' if current_status == 'COMPLETED' else 'bg-warning' if current_status in ['EXECUTING', 'ONGOING'] else 'bg-secondary' }}">
                                    {% if current_status == 'CANCELLED' %}
                                        <i class="fas fa-times-circle me-1"></i>
                                    {% endif %}
                                    {{ current_status }}
                                </span>
                            </span>
                            <select class="form-control form-select edit-input d-none" data-original="{{ current_status }}">
                                <option value="ASSIGNED" {{ 'selected' if current_status == 'ASSIGNED' else '' }}>ASSIGNED</option>
                                <option value="EXECUTING" {{ 'selected' if current_status == 'EXECUTING' else '' }}>EXECUTING</option>
                                <option value="COMPLETED" {{ 'selected' if current_status == 'COMPLETED' else '' }}>COMPLETED</option>
                                <option value="CANCELLED" {{ 'selected' if current_status == 'CANCELLED' else '' }}>CANCELLED</option>
                                <option value="OPEN" {{ 'selected' if current_status == 'OPEN' else '' }}>OPEN</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Channel:</label>
                            <span>{{ order.channel or 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Mode:</label>
                            <span>{{ order.mode or 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Date:</label>
                            <span>{{ date }}</span>
                        </div>
                    </div>
                </div>

                <!-- Additional Status Information -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>SLA Status:</label>
                            <span class="badge {{ 'bg-success' if order.sla_status == 'ON_TIME' else 'bg-danger' if order.sla_status == 'DELAYED' else 'bg-secondary' }}">
                                {{ order.sla_status or 'N/A' }}
                            </span>
                        </div>
                    </div>
                    {% if order.tardiness %}
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Tardiness:</label>
                            <span class="badge {{ 'bg-danger' if order.tardiness > 30 else 'bg-warning' if order.tardiness > 0 else 'bg-success' }}">
                                {{ order.tardiness|round(2) }} min
                            </span>
                        </div>
                    </div>
                    {% endif %}
                    {% if order.effective_tat %}
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Effective TAT:</label>
                            <span>{{ order.effective_tat }} min</span>
                        </div>
                    </div>
                    {% endif %}
                    {% if order.amount_collected %}
                    <div class="col-md-3">
                        <div class="info-item">
                            <label>Amount Collected:</label>
                            <span class="text-success fw-bold">${{ order.amount_collected }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Order Flags -->
                {% if order.partially_delivered or order.reassigned or order.rejected or order.unassigned %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="info-item">
                            <label>Order Flags:</label>
                            <div class="d-flex gap-2 flex-wrap">
                                {% if order.partially_delivered %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Partially Delivered
                                    </span>
                                {% endif %}
                                {% if order.reassigned %}
                                    <span class="badge bg-info">
                                        <i class="fas fa-exchange-alt me-1"></i>Reassigned
                                    </span>
                                {% endif %}
                                {% if order.rejected %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>Rejected
                                    </span>
                                {% endif %}
                                {% if order.unassigned %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-user-times me-1"></i>Unassigned
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Cancellation Information (dynamic visibility) -->
                <div id="cancellation-section" class="alert alert-danger mb-4" style="display: {{ 'block' if order.cancellation_reason or (current_status == 'CANCELLED') else 'none' }};">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>Order Cancelled
                    </h6>
                    <div class="mb-2 editable-field" data-field="cancellation_reason">
                        <strong>Cancellation Reason:</strong>
                        <span class="display-value">{{ order.cancellation_reason or 'Not specified' }}</span>
                        <textarea class="form-control edit-input d-none" rows="2"
                                  data-original="{{ order.cancellation_reason or '' }}">{{ order.cancellation_reason or '' }}</textarea>
                    </div>
                    {% if order.last_status_update %}
                    <div>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Last updated: {{ order.last_status_update.split('T')[0] }} {{ order.last_status_update.split('T')[1].split('.')[0] if 'T' in order.last_status_update else '' }}
                            {% if order.status_actor %} by {{ order.status_actor }}{% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>

                <!-- Location Information -->
                {% if order.location %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-map-marker-alt me-2"></i>Delivery Location</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-2 editable-field" data-field="location_name">
                                    <label>Name:</label>
                                    <span class="display-value fw-bold">{{ order.location.name }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.location.name }}" data-original="{{ order.location.name }}">
                                </div>
                                <div class="info-item mb-2 editable-field" data-field="location_id">
                                    <label>ID:</label>
                                    <span class="display-value">{{ order.location.id }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.location.id }}" data-original="{{ order.location.id }}">
                                </div>
                                <div class="info-item mb-2">
                                    <label>Status:</label>
                                    <span class="badge bg-info">{{ order.location.status }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item mb-2 editable-field" data-field="location_city">
                                    <label>City:</label>
                                    <span class="display-value">{{ order.location.address.city or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.location.address.city or '' }}" data-original="{{ order.location.address.city or '' }}">
                                </div>
                                <div class="info-item mb-2">
                                    <label>Country:</label>
                                    <span>{{ order.location.address.countryCode or 'N/A' }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label>Coordinates:</label>
                                    <span>{{ order.location.latLng.lat }}, {{ order.location.latLng.lng }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label>Full Address:</label>
                            <p class="text-muted">{{ order.location.address.formattedAddress }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Tour/Delivery Information -->
                {% if order.orderMetadata.tourDetail or order.tour_id %}
                {% set tour = order.orderMetadata.tourDetail or {} %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-truck me-2"></i>Delivery Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-item mb-2 editable-field" data-field="rider_name">
                                    <label>Rider:</label>
                                    <span class="display-value fw-bold">{{ order.rider_name or tour.riderName or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.rider_name or tour.riderName or '' }}"
                                           data-original="{{ order.rider_name or tour.riderName or '' }}">
                                </div>
                                <div class="info-item mb-2 editable-field" data-field="rider_phone">
                                    <label>Phone:</label>
                                    <span class="display-value">{{ order.rider_phone or tour.riderNumber or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.rider_phone or tour.riderNumber or '' }}"
                                           data-original="{{ order.rider_phone or tour.riderNumber or '' }}">
                                </div>
                                <div class="info-item mb-2 editable-field" data-field="rider_id">
                                    <label>Rider ID:</label>
                                    <span class="display-value">{{ order.rider_id or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.rider_id or '' }}"
                                           data-original="{{ order.rider_id or '' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item mb-2 editable-field" data-field="vehicle_registration">
                                    <label>Vehicle:</label>
                                    <span class="display-value fw-bold">{{ order.vehicle_registration or tour.vehicleRegistrationNumber or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.vehicle_registration or tour.vehicleRegistrationNumber or '' }}"
                                           data-original="{{ order.vehicle_registration or tour.vehicleRegistrationNumber or '' }}">
                                </div>
                                <div class="info-item mb-2">
                                    <label>Model:</label>
                                    <span>{{ order.vehicle_model or tour.vehicleModelName or 'N/A' }}</span>
                                </div>
                                <div class="info-item mb-2 editable-field" data-field="vehicle_id">
                                    <label>Vehicle ID:</label>
                                    <span class="display-value">{{ order.vehicle_id or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.vehicle_id or '' }}"
                                           data-original="{{ order.vehicle_id or '' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item mb-2">
                                    <label>Tour ID:</label>
                                    <span class="small">{{ order.tour_id or tour.tourId or 'N/A' }}</span>
                                </div>
                                <div class="info-item mb-2 editable-field" data-field="tour_name">
                                    <label>Tour Name:</label>
                                    <span class="display-value">{{ order.tour_name or 'N/A' }}</span>
                                    <input type="text" class="form-control edit-input d-none"
                                           value="{{ order.tour_name or '' }}"
                                           data-original="{{ order.tour_name or '' }}">
                                </div>
                                <div class="info-item mb-2">
                                    <label>Sequence:</label>
                                    <span>{{ order.sequence_in_batch or tour.sequence or 'N/A' }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label>Transporter:</label>
                                    <span>{{ order.transporter_name or tour.transporterName or 'N/A' }}</span>
                                </div>
                                {% if tour.tourStartTime %}
                                <div class="info-item mb-2">
                                    <label>Start Time:</label>
                                    <span>{{ tour.tourStartTime.split('T')[1].split('.')[0] if 'T' in tour.tourStartTime else tour.tourStartTime }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Tour Details -->
                        {% if order.tour_date or order.tour_plan_id %}
                        <div class="row mt-3">
                            {% if order.tour_date %}
                            <div class="col-md-4">
                                <div class="info-item mb-2">
                                    <label>Tour Date:</label>
                                    <span>{{ order.tour_date }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.tour_plan_id %}
                            <div class="col-md-4">
                                <div class="info-item mb-2">
                                    <label>Plan ID:</label>
                                    <span>{{ order.tour_plan_id }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.tour_number %}
                            <div class="col-md-4">
                                <div class="info-item mb-2">
                                    <label>Tour Number:</label>
                                    <span>{{ order.tour_number }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Enhanced Line Items with SKU Details -->
                {% if order.lineItems %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-list me-2"></i>Order Items (<span id="items-count">{{ order.lineItems|length }}</span>)</h6>
                        <div class="order-items-actions d-none">
                            <button class="btn btn-success btn-sm" onclick="saveOrderItems()">
                                <i class="fas fa-save"></i> Save Items
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelOrderItemsEdit()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="addOrderItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="order-items-table">
                                <thead>
                                    <tr>
                                        <th>SKU ID</th>
                                        <th>Product Name</th>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Weight (per unit)</th>
                                        <th>Volume (per unit)</th>
                                        <th>Unit</th>
                                        <th>Handling Unit</th>
                                        <th class="order-items-actions d-none">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="order-items-tbody">
                                    {% for item in order.lineItems %}
                                    <tr data-item-id="{{ item.id }}" data-original-data="{{ item|tojson|e }}">
                                        <td class="editable-cell" data-field="sku_id">
                                            <span class="display-value"><code>{{ item.id }}</code></span>
                                            <input type="text" class="form-control form-control-sm edit-input d-none" value="{{ item.id }}" data-original="{{ item.id }}">
                                        </td>
                                        <td class="editable-cell" data-field="name">
                                            <span class="display-value"><strong>{{ item.name }}</strong></span>
                                            <input type="text" class="form-control form-control-sm edit-input d-none" value="{{ item.name }}" data-original="{{ item.name }}">
                                        </td>
                                        <td class="editable-cell" data-field="description">
                                            <span class="display-value"><small class="text-muted">{{ item.description or 'N/A' }}</small></span>
                                            <input type="text" class="form-control form-control-sm edit-input d-none" value="{{ item.description or '' }}" data-original="{{ item.description or '' }}">
                                        </td>
                                        <td class="editable-cell" data-field="quantity">
                                            <span class="display-value">
                                                <span class="badge bg-primary">{{ item.quantity }} {{ item.quantityUnit }}</span>
                                            </span>
                                            <input type="number" class="form-control form-control-sm edit-input d-none" value="{{ item.quantity }}" data-original="{{ item.quantity }}">
                                        </td>
                                        <td class="editable-cell" data-field="weight">
                                            <span class="display-value">
                                                {% if item.totalWeight %}
                                                    {{ item.totalWeight.value }}{{ item.totalWeight.unit }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                            <input type="number" step="0.01" class="form-control form-control-sm edit-input d-none"
                                                   value="{{ item.totalWeight.value if item.totalWeight else '' }}" data-original="{{ item.totalWeight.value if item.totalWeight else '' }}">
                                        </td>
                                        <td class="editable-cell" data-field="volume">
                                            <span class="display-value">
                                                {% if item.totalVolume %}
                                                    {{ item.totalVolume.value }}{{ item.totalVolume.unit }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                            <input type="number" step="0.01" class="form-control form-control-sm edit-input d-none"
                                                   value="{{ item.totalVolume.value if item.totalVolume else '' }}" data-original="{{ item.totalVolume.value if item.totalVolume else '' }}">
                                        </td>
                                        <td class="editable-cell" data-field="unit">
                                            <span class="display-value">{{ item.quantityUnit }}</span>
                                            <select class="form-control form-control-sm edit-input d-none" data-original="{{ item.quantityUnit }}">
                                                <option value="PIECES" {{ 'selected' if item.quantityUnit == 'PIECES' else '' }}>PIECES</option>
                                                <option value="BOXES" {{ 'selected' if item.quantityUnit == 'BOXES' else '' }}>BOXES</option>
                                                <option value="KILOGRAMS" {{ 'selected' if item.quantityUnit == 'KILOGRAMS' else '' }}>KILOGRAMS</option>
                                                <option value="LITERS" {{ 'selected' if item.quantityUnit == 'LITERS' else '' }}>LITERS</option>
                                            </select>
                                        </td>
                                        <td class="editable-cell" data-field="handling_unit">
                                            <span class="display-value"><span class="badge bg-info">{{ item.handlingUnit }}</span></span>
                                            <input type="text" class="form-control form-control-sm edit-input d-none" value="{{ item.handlingUnit }}" data-original="{{ item.handlingUnit }}">
                                        </td>
                                        <td class="order-items-actions d-none">
                                            <button class="btn btn-danger btn-sm" onclick="deleteOrderItem(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Order Summary -->
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="alert alert-info">
                                        <strong>Total Weight:</strong><br>
                                        {{ order.weight.value }}{{ order.weight.unit }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-warning">
                                        <strong>Total Volume:</strong><br>
                                        {{ order.volume.value }}{{ order.volume.unit }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-success">
                                        <strong>Total Quantity:</strong><br>
                                        {{ order.quantity.value }} {{ order.quantity.unit }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Transaction Details -->
                {% if order.orderMetadata.lineItems %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6><i class="fas fa-exchange-alt me-2"></i>Transaction Details ({{ order.orderMetadata.lineItems|length }} items)</h6>
                        <div class="transaction-actions d-none">
                            <button class="btn btn-success btn-sm" onclick="saveTransactionDetails()">
                                <i class="fas fa-save"></i> Save Transactions
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelTransactionEdit()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="transaction-table">
                                <thead>
                                    <tr>
                                        <th>SKU ID</th>
                                        <th>Ordered</th>
                                        <th>Delivered</th>
                                        <th>Weight</th>
                                        <th>Status</th>
                                        <th>Delivered At</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-tbody">
                                    {% for item in order.orderMetadata.lineItems %}
                                    <tr data-transaction-id="{{ item.id }}">
                                        <td><code>{{ item.id }}</code></td>
                                        <td class="editable-cell" data-field="ordered_quantity">
                                            <span class="display-value">{{ item.transactionStatus.orderedQuantity }}</span>
                                            <input type="number" class="form-control form-control-sm edit-input d-none" value="{{ item.transactionStatus.orderedQuantity }}">
                                        </td>
                                        <td class="editable-cell" data-field="transacted_quantity">
                                            <span class="display-value">
                                                <span class="badge bg-primary">{{ item.transactionStatus.transactedQuantity }}</span>
                                            </span>
                                            <input type="number" class="form-control form-control-sm edit-input d-none" value="{{ item.transactionStatus.transactedQuantity }}">
                                        </td>
                                        <td class="editable-cell" data-field="transacted_weight">
                                            <span class="display-value">
                                                {% if item.transactionStatus.transactedWeight %}
                                                    {{ item.transactionStatus.transactedWeight.value }}{{ item.transactionStatus.transactedWeight.unit }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                            <input type="number" step="0.01" class="form-control form-control-sm edit-input d-none"
                                                   value="{{ item.transactionStatus.transactedWeight.value if item.transactionStatus.transactedWeight else '' }}">
                                        </td>
                                        <td class="editable-cell" data-field="transaction_status">
                                            <span class="display-value"><span class="badge bg-success">{{ item.transactionStatus.status }}</span></span>
                                            <select class="form-control form-control-sm edit-input d-none">
                                                <option value="DELIVERED" {{ 'selected' if item.transactionStatus.status == 'DELIVERED' else '' }}>DELIVERED</option>
                                                <option value="PARTIALLY_DELIVERED" {{ 'selected' if item.transactionStatus.status == 'PARTIALLY_DELIVERED' else '' }}>PARTIALLY_DELIVERED</option>
                                                <option value="NOT_DELIVERED" {{ 'selected' if item.transactionStatus.status == 'NOT_DELIVERED' else '' }}>NOT_DELIVERED</option>
                                                <option value="RETURNED" {{ 'selected' if item.transactionStatus.status == 'RETURNED' else '' }}>RETURNED</option>
                                            </select>
                                        </td>
                                        <td>
                                            {% if item.transactionStatus.triggerTime %}
                                                <small>{{ item.transactionStatus.triggerTime.split('T')[1].split('.')[0] if 'T' in item.transactionStatus.triggerTime else item.transactionStatus.triggerTime }}</small>
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Timing Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-clock me-2"></i>Timing Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% if order.orderMetadata.homebaseEta %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Homebase ETA:</label>
                                    <span>{{ order.orderMetadata.homebaseEta.split('T')[1].split('.')[0] if 'T' in order.orderMetadata.homebaseEta else order.orderMetadata.homebaseEta }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.orderMetadata.homebaseEtd %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Homebase ETD:</label>
                                    <span>{{ order.orderMetadata.homebaseEtd.split('T')[1].split('.')[0] if 'T' in order.orderMetadata.homebaseEtd else order.orderMetadata.homebaseEtd }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.orderMetadata.currentEta %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Current ETA:</label>
                                    <span>{{ order.orderMetadata.currentEta.split('T')[1].split('.')[0] if 'T' in order.orderMetadata.currentEta else order.orderMetadata.currentEta }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.orderMetadata.homebaseCompleteOn %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Completed (API):</label>
                                    <span class="text-success fw-bold">{{ order.orderMetadata.homebaseCompleteOn.split('T')[1].split('.')[0] if 'T' in order.orderMetadata.homebaseCompleteOn else order.orderMetadata.homebaseCompleteOn }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.completed_on %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Completed (DB):</label>
                                    <span class="text-success fw-bold">{{ order.completed_on.split('T')[1].split('.')[0] if 'T' in order.completed_on else order.completed_on }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.eta_updated_on %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>ETA Updated:</label>
                                    <span>{{ order.eta_updated_on.split('T')[0] if 'T' in order.eta_updated_on else order.eta_updated_on[:10] }} {{ order.eta_updated_on.split('T')[1].split('.')[0] if 'T' in order.eta_updated_on else '' }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.tour_updated_on %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Tour Updated:</label>
                                    <span>{{ order.tour_updated_on.split('T')[0] if 'T' in order.tour_updated_on else order.tour_updated_on[:10] }} {{ order.tour_updated_on.split('T')[1].split('.')[0] if 'T' in order.tour_updated_on else '' }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.initial_assignment_at %}
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Initial Assignment:</label>
                                    <span>{{ order.initial_assignment_at.split('T')[0] if 'T' in order.initial_assignment_at else order.initial_assignment_at[:10] }} {{ order.initial_assignment_at.split('T')[1].split('.')[0] if 'T' in order.initial_assignment_at else '' }}</span>
                                    {% if order.initial_assignment_by %}
                                        <br><small class="text-muted">by {{ order.initial_assignment_by }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Edit Actions (hidden by default) -->
                    <div class="edit-actions d-none pt-3 border-top">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="saveOrderChanges()">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="btn btn-secondary" onclick="cancelOrderEdit()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-info" onclick="toggleOrderItemsEdit()">
                                <i class="fas fa-list"></i> Edit Items
                            </button>
                            <button class="btn btn-warning" onclick="toggleTransactionEdit()">
                                <i class="fas fa-exchange-alt"></i> Edit Transactions
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Skills, Tags, and Custom Fields -->
                {% if order.skills or order.tags or order.custom_fields %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-tags me-2"></i>Additional Information</h6>
                    </div>
                    <div class="card-body">
                        {% if order.skills %}
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="info-item">
                                    <label>Required Skills:</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        {% if order.skills is string %}
                                            <span class="badge bg-primary">{{ order.skills }}</span>
                                        {% else %}
                                            {% for skill in order.skills %}
                                                <span class="badge bg-primary">{{ skill }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if order.tags %}
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="info-item">
                                    <label>Tags:</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        {% if order.tags is string %}
                                            <span class="badge bg-info">{{ order.tags }}</span>
                                        {% else %}
                                            {% for tag in order.tags %}
                                                <span class="badge bg-info">{{ tag }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if order.custom_fields %}
                        <div class="row">
                            <div class="col-12">
                                <div class="info-item">
                                    <label>Custom Fields:</label>
                                    <div class="mt-2">
                                        {% if order.custom_fields is mapping %}
                                            {% for key, value in order.custom_fields.items() %}
                                                <div class="mb-2">
                                                    <strong>{{ key }}:</strong> {{ value }}
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <pre class="small">{{ order.custom_fields }}</pre>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Homebase Information -->
                {% if order.homebase %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-warehouse me-2"></i>Homebase Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Name:</label>
                                    <span class="fw-bold">{{ order.homebase.name }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label>ID:</label>
                                    <span>{{ order.homebase.id }}</span>
                                </div>
                                <div class="info-item mb-2">
                                    <label>Type:</label>
                                    <span>{{ order.homebase.type }}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item mb-2">
                                    <label>Status:</label>
                                    <span class="badge bg-success">{{ order.homebase.status }}</span>
                                </div>
                                {% if order.homebase.address %}
                                <div class="info-item mb-2">
                                    <label>Address:</label>
                                    <span>{{ order.homebase.address.formattedAddress }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Proof of Delivery -->
                {% if order.orderMetadata.customerProofOfCompletion %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-camera me-2"></i>Proof of Delivery</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% if order.orderMetadata.customerProofOfCompletion["Customer Delivery Photo"] %}
                            <div class="col-md-4">
                                <div class="proof-item text-center">
                                    <h6>Delivery Photo</h6>
                                    <a href="{{ order.orderMetadata.customerProofOfCompletion['Customer Delivery Photo']['Customer Delivery Photo'] }}" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-camera me-1"></i>View Photo
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.orderMetadata.customerProofOfCompletion["Customer Confirmation Signature"] %}
                            <div class="col-md-4">
                                <div class="proof-item text-center">
                                    <h6>Customer Signature</h6>
                                    <a href="{{ order.orderMetadata.customerProofOfCompletion['Customer Confirmation Signature']['Customer Confirmation Signature'] }}" target="_blank" class="btn btn-outline-success">
                                        <i class="fas fa-signature me-1"></i>View Signature
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% if order.orderMetadata.customerProofOfCompletion["Proof Of Delivery Document"] %}
                            <div class="col-md-4">
                                <div class="proof-item text-center">
                                    <h6>Delivery Document</h6>
                                    <a href="{{ order.orderMetadata.customerProofOfCompletion['Proof Of Delivery Document']['Proof Of Delivery Document'] }}" target="_blank" class="btn btn-outline-warning">
                                        <i class="fas fa-file-pdf me-1"></i>View Document
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Order Timeline -->
                {% if order.timeline %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-clock me-2"></i>Order Timeline</h6>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for event in order.timeline[-10:] %}
                            <div class="timeline-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ event.type.replace('_', ' ').title() }}</strong>
                                        {% if event.orderStatus %}
                                            <span class="badge bg-primary ms-2">{{ event.orderStatus }}</span>
                                        {% endif %}
                                        {% if event.orderSubStatus %}
                                            <span class="badge bg-secondary ms-1">{{ event.orderSubStatus }}</span>
                                        {% endif %}
                                        <br>
                                        {% if event.updatedBy %}
                                            <small class="text-muted">by {{ event.updatedBy }}</small>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        {{ event.eventTimestamp.split('T')[0] if 'T' in event.eventTimestamp else event.eventTimestamp[:10] }}<br>
                                        {{ event.eventTimestamp.split('T')[1].split('.')[0] if 'T' in event.eventTimestamp else event.eventTimestamp[11:19] }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if order.timeline|length > 10 %}
                        <small class="text-muted">Showing last 10 events of {{ order.timeline|length }} total events</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Raw JSON Data -->
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-code me-2"></i>Complete Order Data (JSON)</h6>
                    </div>
                    <div class="card-body">
                        <div class="order-details-container">
                            <pre class="order-json">{{ order | tojson(indent=2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.info-item {
    margin-bottom: 8px;
}

.info-item label {
    font-weight: 600;
    color: #6c757d;
    display: inline-block;
    min-width: 100px;
}

.clickable-card {
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
}

.order-json {
    font-size: 11px;
    max-height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 5px;
    padding: 15px;
}
</style>

<script>
// Function to validate order GRN
async function validateOrder(orderId, date) {
    const statusDiv = document.getElementById('validation-status');
    const button = document.getElementById('validate-order-btn');

    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-1"></i>Processing validation...</div>';

    try {
        const response = await fetch(`/validate-order/${orderId}?date=${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            if (result.is_valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>Validation Successful!</h5>
                        <p class="mb-0">The GRN document matches the order data perfectly. All items and quantities are correct.</p>
                        ${result.confidence_score ? `<small class="text-muted">Confidence Score: ${Math.round(result.confidence_score * 100)}%</small>` : ''}
                    </div>
                `;
            } else {
                const discrepancies = result.discrepancies.map(d =>
                    `<li><strong>${d.type}:</strong> ${d.description}
                        ${d.expected ? `<br><small class="text-muted">Expected: ${d.expected}</small>` : ''}
                        ${d.actual ? `<br><small class="text-muted">Actual: ${d.actual}</small>` : ''}
                    </li>`
                ).join('');

                const summary = result.summary || {};
                const recommendations = result.validation_data?.recommendations || [];
                const fallbackNote = result.fallback ? `<div class="alert alert-info mb-3"><i class="fas fa-info-circle me-1"></i>Note: This is a partial analysis due to response processing issues. Some details may be incomplete.</div>` : '';

                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Validation Failed!</h5>
                        ${fallbackNote}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Summary:</strong>
                                <ul class="mb-0">
                                    <li>Items Expected: ${summary.total_items_expected || 'Unknown'}</li>
                                    <li>Items Found: ${summary.total_items_found || 'Unknown'}</li>
                                    <li>Items Matched: ${summary.items_matched || 0}</li>
                                    <li>Items with Issues: ${summary.items_with_discrepancies || 0}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                ${result.confidence_score ? `<strong>Confidence Score:</strong> ${Math.round(result.confidence_score * 100)}%` : ''}
                            </div>
                        </div>
                        ${discrepancies.length > 0 ? `
                            <p><strong>Issues Found:</strong></p>
                            <ul class="mb-2">${discrepancies}</ul>
                        ` : '<p class="text-muted">Specific discrepancies could not be determined from the partial response.</p>'}
                        ${result.gtin_verification && result.gtin_verification.length > 0 ? `
                            <div class="mt-3">
                                <p><strong>GTIN Verification Results:</strong></p>
                                <div class="row">
                                    ${result.gtin_verification.map(gtin => `
                                        <div class="col-md-6 mb-2">
                                            <div class="card ${gtin.gs1_verified ? (gtin.name_match ? 'border-success' : 'border-warning') : 'border-danger'}">
                                                <div class="card-body p-2">
                                                    <h6 class="card-title mb-1">
                                                        <span class="badge ${gtin.gs1_verified ? (gtin.name_match ? 'bg-success' : 'bg-warning') : 'bg-danger'}">
                                                            ${gtin.gs1_verified ? (gtin.name_match ? '✓' : '⚠') : '✗'}
                                                        </span>
                                                        GTIN: ${gtin.gtin}
                                                    </h6>
                                                    <p class="card-text small mb-1">
                                                        <strong>Document:</strong> ${gtin.extracted_name}<br>
                                                        ${gtin.gs1_product_info ? `
                                                            <strong>GS1 Verified:</strong> ${gtin.gs1_product_info.product_name}<br>
                                                            <strong>Brand:</strong> ${gtin.gs1_product_info.brand_name || 'N/A'}<br>
                                                            <strong>Company:</strong> ${gtin.gs1_product_info.company_name || 'N/A'}
                                                        ` : '<strong>GS1 Status:</strong> Not found in registry'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${recommendations.length > 0 ? `
                            <p><strong>Recommendations:</strong></p>
                            <ul class="mb-2">
                                ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        ` : ''}
                        <p class="mb-0"><small class="text-muted">Please review the delivery document and order details carefully.</small></p>
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Validation Error</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error occurred'}</p>
                    ${result.ai_response ? `<p class="mb-0"><small class="text-muted">AI response was received but could not be processed properly.</small></p>` : ''}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-times-circle me-2"></i>Error</h5>
                <p class="mb-0">Failed to validate order. Please try again or contact support if the issue persists.</p>
            </div>
        `;
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Validate GRN';
    }
}

// Event listeners for validation and reprocess buttons
document.addEventListener('DOMContentLoaded', function() {
    const validateBtn = document.getElementById('validate-order-btn');
    if (validateBtn) {
        validateBtn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const date = this.getAttribute('data-date');
            validateOrder(orderId, date);
        });
    }

    const reprocessBtn = document.getElementById('reprocess-order-btn');
    if (reprocessBtn) {
        reprocessBtn.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const date = this.getAttribute('data-date');
            reprocessOrder(orderId, date);
        });
    }
});

// Function to re-process order (for order detail page)
async function reprocessOrder(orderId, date) {
    const statusDiv = document.getElementById('validation-status');
    const button = document.getElementById('reprocess-order-btn');

    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Re-processing...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-1"></i>Re-processing with AI...</div>';

    try {
        const response = await fetch(`/validate-order/${orderId}?date=${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                force_reprocess: true
            })
        });

        const result = await response.json();

        if (result.success) {
            if (result.is_valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>Re-processing Successful!</h5>
                        <p class="mb-0">The GRN document has been re-processed and matches the order data perfectly.</p>
                        ${result.confidence_score ? `<small class="text-muted">Confidence Score: ${Math.round(result.confidence_score * 100)}%</small>` : ''}
                    </div>
                `;
            } else {
                const discrepancies = result.discrepancies.map(d =>
                    `<li><strong>${d.type}:</strong> ${d.description}
                        ${d.expected ? `<br><small class="text-muted">Expected: ${d.expected}</small>` : ''}
                        ${d.actual ? `<br><small class="text-muted">Actual: ${d.actual}</small>` : ''}
                    </li>`
                ).join('');

                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Re-processing Found Issues!</h5>
                        <p><strong>Issues Found:</strong></p>
                        <ul class="mb-2">${discrepancies}</ul>
                        ${result.confidence_score ? `<small class="text-muted">Confidence Score: ${Math.round(result.confidence_score * 100)}%</small>` : ''}
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Re-processing Error</h5>
                    <p class="mb-0">${result.error || result.message || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-times-circle me-2"></i>Error</h5>
                <p class="mb-0">Failed to re-process order. Please try again or contact support if the issue persists.</p>
            </div>
        `;
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-redo me-1"></i>Re-process GRN';
    }
}

// Order editing functionality
let isEditingOrder = false;

function toggleOrderEdit() {
    isEditingOrder = !isEditingOrder;
    const editBtn = document.getElementById('edit-order-btn');
    const editActions = document.querySelector('.edit-actions');
    const editableFields = document.querySelectorAll('.editable-field');

    if (isEditingOrder) {
        // Enter edit mode
        editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Edit';
        editBtn.className = 'btn btn-secondary me-2';
        editActions.classList.remove('d-none');

        editableFields.forEach(field => {
            const displayValue = field.querySelector('.display-value');
            const input = field.querySelector('.edit-input');
            if (displayValue && input) {
                displayValue.classList.add('d-none');
                input.classList.remove('d-none');
            }
        });
    } else {
        cancelOrderEdit();
    }
}

function cancelOrderEdit() {
    isEditingOrder = false;
    const editBtn = document.getElementById('edit-order-btn');
    const editActions = document.querySelector('.edit-actions');
    const editableFields = document.querySelectorAll('.editable-field');

    // Reset button
    editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Order';
    editBtn.className = 'btn btn-primary me-2';
    editActions.classList.add('d-none');

    // Reset fields
    editableFields.forEach(field => {
        const displayValue = field.querySelector('.display-value');
        const input = field.querySelector('.edit-input');

        if (displayValue && input) {
            // Reset input to original value
            if (input.tagName === 'TEXTAREA') {
                input.value = input.getAttribute('data-original');
            } else if (input.tagName === 'SELECT') {
                input.value = input.getAttribute('data-original');
            } else {
                input.value = input.getAttribute('data-original');
            }

            displayValue.classList.remove('d-none');
            input.classList.add('d-none');
        }
    });
}

function saveOrderChanges() {
    const orderId = '{{ order_id }}';
    const changes = {};
    let hasChanges = false;

    // Collect changes
    document.querySelectorAll('.editable-field').forEach(field => {
        const input = field.querySelector('.edit-input');
        const fieldName = field.getAttribute('data-field');

        if (input) {
            const originalValue = input.getAttribute('data-original') || '';
            let currentValue;

            if (input.tagName === 'TEXTAREA') {
                currentValue = input.value.trim();
            } else if (input.tagName === 'SELECT') {
                currentValue = input.value;
            } else {
                currentValue = input.value.trim();
            }

            if (currentValue !== originalValue) {
                changes[fieldName] = currentValue;
                hasChanges = true;
            }
        }
    });

    if (!hasChanges) {
        showOrderAlert('info', 'No changes to save.');
        cancelOrderEdit();
        return;
    }

    // Show loading state
    const saveBtn = document.querySelector('.edit-actions .btn-success');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Save changes
    fetch(`/api/orders/${orderId}/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modified_by: 'User',
            data: changes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showOrderAlert('success', `Order updated successfully! ${data.message}`);

            // Update displayed values
            Object.keys(changes).forEach(fieldName => {
                const field = document.querySelector(`[data-field="${fieldName}"]`);
                if (field) {
                    const displayValue = field.querySelector('.display-value');
                    const input = field.querySelector('.edit-input');
                    const newValue = changes[fieldName];

                    // Update display based on field type
                    if (fieldName === 'order_status') {
                        // Special handling for status badge
                        const badge = displayValue.querySelector('.badge');
                        if (badge) {
                            badge.textContent = newValue;
                            // Update badge class based on status
                            badge.className = `badge ${getBadgeClassForStatus(newValue)}`;
                        }

                        // Handle cancellation section visibility
                        const cancellationSection = document.getElementById('cancellation-section');
                        if (newValue === 'CANCELLED') {
                            cancellationSection.style.display = 'block';
                        } else {
                            cancellationSection.style.display = 'none';
                            // Clear cancellation reason when status is not cancelled
                            const cancellationField = document.querySelector('[data-field="cancellation_reason"]');
                            if (cancellationField) {
                                const cancellationDisplay = cancellationField.querySelector('.display-value');
                                const cancellationInput = cancellationField.querySelector('.edit-input');
                                cancellationDisplay.textContent = 'Not specified';
                                cancellationInput.value = '';
                                cancellationInput.setAttribute('data-original', '');
                            }
                        }
                    } else if (fieldName === 'cancellation_reason') {
                        // Update textarea display
                        displayValue.textContent = newValue || 'Not specified';
                    } else {
                        // Regular text update
                        displayValue.textContent = newValue || 'N/A';
                    }

                    // Update original value for future editing
                    input.setAttribute('data-original', newValue);
                }
            });

            cancelOrderEdit();

            // Handle status change notifications
            if (changes.order_status === 'CANCELLED') {
                showOrderAlert('info', 'Order marked as cancelled. You can now add cancellation reason.');
                // Automatically enable edit mode again if status was changed to CANCELLED
                // This allows user to immediately set the cancellation reason
                setTimeout(() => {
                    if (!isEditingOrder) {
                        toggleOrderEdit();
                        // Focus on cancellation reason field
                        const cancellationInput = document.querySelector('[data-field="cancellation_reason"] .edit-input');
                        if (cancellationInput) {
                            cancellationInput.focus();
                        }
                    }
                }, 1000);
            } else if (data.updated_fields && data.updated_fields.includes('cancellation_reason')) {
                // Check if cancellation reason was cleared due to status change
                const cancellationField = document.querySelector('[data-field="cancellation_reason"]');
                if (cancellationField) {
                    const cancellationDisplay = cancellationField.querySelector('.display-value');
                    const cancellationInput = cancellationField.querySelector('.edit-input');
                    cancellationDisplay.textContent = 'Not specified';
                    cancellationInput.value = '';
                    cancellationInput.setAttribute('data-original', '');
                }
                showOrderAlert('info', 'Order status changed. Cancellation reason has been cleared.');
            }
        } else {
            showOrderAlert('danger', `Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showOrderAlert('danger', 'An error occurred while saving changes.');
    })
    .finally(() => {
        // Reset button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function getBadgeClassForStatus(status) {
    switch (status) {
        case 'CANCELLED':
            return 'bg-danger';
        case 'COMPLETED':
            return 'bg-success';
        case 'EXECUTING':
        case 'ONGOING':
            return 'bg-warning';
        default:
            return 'bg-secondary';
    }
}

function showOrderAlert(type, message) {
    // Remove existing alerts
    document.querySelectorAll('.order-edit-alert').forEach(alert => alert.remove());

    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show order-edit-alert`;
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at the top of the content
    const firstElement = document.querySelector('.row.mb-3');
    firstElement.parentNode.insertBefore(alertDiv, firstElement);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Order Items editing functionality
let isEditingOrderItems = false;

function toggleOrderItemsEdit() {
    isEditingOrderItems = !isEditingOrderItems;
    const editBtn = document.getElementById('edit-order-btn');
    const itemsActions = document.querySelectorAll('.order-items-actions');
    const editableCells = document.querySelectorAll('#order-items-table .editable-cell');

    if (isEditingOrderItems) {
        // Show items editing controls
        itemsActions.forEach(action => action.classList.remove('d-none'));

        // Make cells editable
        editableCells.forEach(cell => {
            const displayValue = cell.querySelector('.display-value');
            const input = cell.querySelector('.edit-input');
            if (displayValue && input) {
                displayValue.classList.add('d-none');
                input.classList.remove('d-none');
            }
        });
    } else {
        cancelOrderItemsEdit();
    }
}

function cancelOrderItemsEdit() {
    isEditingOrderItems = false;
    const itemsActions = document.querySelectorAll('.order-items-actions');
    const editableCells = document.querySelectorAll('#order-items-table .editable-cell');

    // Hide items editing controls
    itemsActions.forEach(action => action.classList.add('d-none'));

    // Reset cells to display mode
    editableCells.forEach(cell => {
        const displayValue = cell.querySelector('.display-value');
        const input = cell.querySelector('.edit-input');
        if (displayValue && input) {
            displayValue.classList.remove('d-none');
            input.classList.add('d-none');
        }
    });

    // Remove any new rows that weren't saved
    const newRows = document.querySelectorAll('#order-items-tbody tr[data-new-item="true"]');
    newRows.forEach(row => row.remove());
}

function addOrderItem() {
    const tbody = document.getElementById('order-items-tbody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-new-item', 'true');

    newRow.innerHTML = `
        <td class="editable-cell" data-field="sku_id">
            <input type="text" class="form-control form-control-sm edit-input" placeholder="Enter SKU ID">
        </td>
        <td class="editable-cell" data-field="name">
            <input type="text" class="form-control form-control-sm edit-input" placeholder="Product Name">
        </td>
        <td class="editable-cell" data-field="description">
            <input type="text" class="form-control form-control-sm edit-input" placeholder="Description">
        </td>
        <td class="editable-cell" data-field="quantity">
            <input type="number" class="form-control form-control-sm edit-input" value="1">
        </td>
        <td class="editable-cell" data-field="weight">
            <input type="number" step="0.01" class="form-control form-control-sm edit-input" placeholder="Weight">
        </td>
        <td class="editable-cell" data-field="volume">
            <input type="number" step="0.01" class="form-control form-control-sm edit-input" placeholder="Volume">
        </td>
        <td class="editable-cell" data-field="unit">
            <select class="form-control form-control-sm edit-input">
                <option value="PIECES">PIECES</option>
                <option value="BOXES">BOXES</option>
                <option value="KILOGRAMS">KILOGRAMS</option>
                <option value="LITERS">LITERS</option>
            </select>
        </td>
        <td class="editable-cell" data-field="handling_unit">
            <input type="text" class="form-control form-control-sm edit-input" placeholder="Handling Unit">
        </td>
        <td>
            <button class="btn btn-danger btn-sm" onclick="deleteOrderItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(newRow);

    // Focus on first input
    const firstInput = newRow.querySelector('input');
    if (firstInput) firstInput.focus();
}

function deleteOrderItem(button) {
    const row = button.closest('tr');
    if (confirm('Are you sure you want to delete this item?')) {
        row.remove();
        updateItemsCount();
    }
}

function updateItemsCount() {
    const count = document.querySelectorAll('#order-items-tbody tr').length;
    document.getElementById('items-count').textContent = count;
}

function saveOrderItems() {
    const orderId = '{{ order_id }}';
    const rows = document.querySelectorAll('#order-items-tbody tr');
    const lineItems = [];

    let hasErrors = false;

    rows.forEach(row => {
        const item = {};
        const cells = row.querySelectorAll('.editable-cell');

        cells.forEach(cell => {
            const field = cell.getAttribute('data-field');
            const input = cell.querySelector('.edit-input');

            if (input) {
                let value = input.value.trim();

                // Validate required fields
                if ((field === 'sku_id' || field === 'name') && !value) {
                    input.classList.add('is-invalid');
                    hasErrors = true;
                    return;
                } else {
                    input.classList.remove('is-invalid');
                }

                // Map fields to API format
                switch (field) {
                    case 'sku_id':
                        item.sku_id = value;
                        break;
                    case 'name':
                        item.name = value;
                        break;
                    case 'description':
                        item.description = value;
                        break;
                    case 'quantity':
                        item.quantity = parseInt(value) || 0;
                        break;
                    case 'weight':
                        item.weight_per_unit = parseFloat(value) || 0;
                        break;
                    case 'volume':
                        item.volume_per_unit = parseFloat(value) || 0;
                        break;
                    case 'unit':
                        item.quantity_unit = value;
                        break;
                    case 'handling_unit':
                        item.handling_unit = value;
                        break;
                }
            }
        });

        // Add item ID for existing items
        const itemId = row.getAttribute('data-item-id');
        if (itemId && !row.getAttribute('data-new-item')) {
            item.id = itemId;
        }

        lineItems.push(item);
    });

    if (hasErrors) {
        showOrderAlert('danger', 'Please fill in all required fields (SKU ID and Product Name).');
        return;
    }

    // Get deleted item IDs
    const deletedItemIds = [];
    // Note: In a full implementation, you'd track deleted items here

    // Save to server
    const saveBtn = document.querySelector('.order-items-actions .btn-success');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Debug: log the data being sent
    console.log('Sending line items data:', {
        modified_by: 'User',
        line_items: lineItems,
        deleted_item_ids: deletedItemIds
    });

    fetch(`/api/orders/${orderId}/line-items/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modified_by: 'User',
            line_items: lineItems,
            deleted_item_ids: deletedItemIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showOrderAlert('success', `Order items updated: ${data.message}`);
            // Refresh page to show updated data
            setTimeout(() => location.reload(), 1500);
        } else {
            showOrderAlert('danger', `Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showOrderAlert('danger', 'An error occurred while saving order items.');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Transaction Details editing functionality
let isEditingTransactions = false;

function toggleTransactionEdit() {
    isEditingTransactions = !isEditingTransactions;
    const transactionActions = document.querySelectorAll('.transaction-actions');
    const editableCells = document.querySelectorAll('#transaction-table .editable-cell');

    if (isEditingTransactions) {
        // Show transaction editing controls
        transactionActions.forEach(action => action.classList.remove('d-none'));

        // Make cells editable
        editableCells.forEach(cell => {
            const displayValue = cell.querySelector('.display-value');
            const input = cell.querySelector('.edit-input');
            if (displayValue && input) {
                displayValue.classList.add('d-none');
                input.classList.remove('d-none');

                // Store original value
                const originalValue = input.value;
                input.setAttribute('data-original', originalValue);
            }
        });
    } else {
        cancelTransactionEdit();
    }
}

function cancelTransactionEdit() {
    isEditingTransactions = false;
    const transactionActions = document.querySelectorAll('.transaction-actions');
    const editableCells = document.querySelectorAll('#transaction-table .editable-cell');

    // Hide transaction editing controls
    transactionActions.forEach(action => action.classList.add('d-none'));

    // Restore display mode
    editableCells.forEach(cell => {
        const displayValue = cell.querySelector('.display-value');
        const input = cell.querySelector('.edit-input');
        if (displayValue && input) {
            displayValue.classList.remove('d-none');
            input.classList.add('d-none');

            // Restore original value
            const originalValue = input.getAttribute('data-original');
            if (originalValue !== null) {
                input.value = originalValue;
            }
            input.classList.remove('is-invalid');
        }
    });
}

function saveTransactionDetails() {
    const orderId = '{{ order_id }}';
    if (!orderId) {
        showOrderAlert('danger', 'Order ID not found.');
        return;
    }

    const transactionRows = document.querySelectorAll('#transaction-tbody tr[data-transaction-id]');
    const transactions = [];
    let hasErrors = false;

    transactionRows.forEach(row => {
        const transactionId = row.getAttribute('data-transaction-id');
        const transaction = {
            id: transactionId
        };

        const editableCells = row.querySelectorAll('.editable-cell');
        editableCells.forEach(cell => {
            const field = cell.getAttribute('data-field');
            const input = cell.querySelector('.edit-input');

            if (input) {
                const value = input.value;

                // Validate required fields
                if ((field === 'ordered_quantity' || field === 'transacted_quantity') && (!value || isNaN(value))) {
                    input.classList.add('is-invalid');
                    hasErrors = true;
                    return;
                } else {
                    input.classList.remove('is-invalid');
                }

                // Map fields to API format
                switch (field) {
                    case 'ordered_quantity':
                        transaction.ordered_quantity = parseInt(value) || 0;
                        break;
                    case 'transacted_quantity':
                        transaction.transacted_quantity = parseInt(value) || 0;
                        break;
                    case 'transacted_weight':
                        transaction.transacted_weight = parseFloat(value) || 0;
                        break;
                    case 'transaction_status':
                        transaction.status = value;
                        break;
                }
            }
        });

        transactions.push(transaction);
    });

    if (hasErrors) {
        showOrderAlert('danger', 'Please fill in all required fields with valid numbers.');
        return;
    }

    // Save to server
    const saveBtn = document.querySelector('.transaction-actions .btn-success');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    fetch(`/api/orders/${orderId}/transactions/edit`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            modified_by: 'User',
            transactions: transactions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showOrderAlert('success', `Transaction details updated: ${data.message}`);
            // Refresh page to show updated data
            setTimeout(() => location.reload(), 1500);
        } else {
            showOrderAlert('danger', `Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showOrderAlert('danger', 'An error occurred while saving transaction details.');
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}
</script>
{% endblock %}