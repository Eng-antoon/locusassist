{% extends "base.html" %}

{% block title %}Delivery Heatmap - Locus Assistant{% endblock %}

{% block content %}
<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Modern Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="text-gradient mb-2">
                    <i class="fas fa-map-marked-alt me-3"></i>Delivery Heatmap
                </h1>
                <p class="text-muted mb-0">Visualize delivery distribution and density across locations</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end">
                    <small class="text-muted d-block">Last Updated</small>
                    <span class="fw-semibold" id="last-updated">--:--:--</span>
                </div>
                <button class="btn btn-primary btn-icon hover-lift" onclick="refreshHeatmap()">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="order-stats-grid mb-4" id="heatmap-stats-grid">
    <!-- Statistics cards will be populated by JavaScript -->
</div>

<!-- Heatmap Controls Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="filters-panel">
            <div class="filters-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>
                    Heatmap Controls
                </h6>
                <button class="btn btn-sm btn-outline-primary" type="button" id="controls-toggle">
                    <i class="fas fa-chevron-down" id="controls-chevron"></i>
                    <span class="ms-1" id="controls-toggle-text">Show Controls</span>
                </button>
            </div>

            <!-- Controls Content -->
            <div id="controls-content" style="display: none;" class="filters-body">
                <div class="row g-4">
                    <!-- Date and Info -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-calendar me-2"></i>Date & Settings
                            </h6>

                            <!-- Date Display (Conditional editing based on date range) -->
                            <div class="mb-3">
                                {% if date_from and date_to %}
                                <label class="form-label">Day Filter (within range)</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="date-filter"
                                           value="{{ day_filter or date_from }}"
                                           min="{{ date_from }}" max="{{ date_to }}"
                                           onchange="updateDateFilter(this.value)">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar text-primary" title="Select specific day within date range"></i>
                                    </span>
                                </div>
                                <small class="text-muted">Select a specific day within the range ({{ date_from }} to {{ date_to }})</small>
                                {% else %}
                                <label class="form-label">Date (from Orders Page)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="display-date" readonly
                                           value="{{ selected_date }}" style="background-color: #f8f9fa;">
                                    <span class="input-group-text">
                                        <i class="fas fa-lock text-muted" title="Date follows Orders page selection"></i>
                                    </span>
                                </div>
                                <small class="text-muted">Date automatically follows your Orders page selection</small>
                                {% endif %}
                            </div>

                            <!-- Aggregation Level -->
                            <div class="mb-3">
                                <label class="form-label">Aggregation Level</label>
                                <select class="form-select" id="aggregation-level">
                                    <option value="coordinate">Exact Coordinates</option>
                                    <option value="area" selected>By Area/Location</option>
                                    <option value="city">By City</option>
                                </select>
                                <small class="text-muted">Choose how to group delivery locations</small>
                            </div>
                        </div>
                    </div>

                    <!-- Map Controls -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-map me-2"></i>Map Controls
                            </h6>

                            <!-- Heatmap Intensity -->
                            <div class="mb-3">
                                <label class="form-label">Heatmap Intensity</label>
                                <input type="range" class="form-range" id="intensity-slider"
                                       min="0.1" max="2.0" step="0.1" value="1.0">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Low</small>
                                    <small class="text-muted" id="intensity-value">1.0</small>
                                    <small class="text-muted">High</small>
                                </div>
                            </div>

                            <!-- Show Options -->
                            <div class="mb-3">
                                <label class="form-label">Display Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-markers" checked>
                                    <label class="form-check-label" for="show-markers">
                                        Show location markers
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-heatmap" checked>
                                    <label class="form-check-label" for="show-heatmap">
                                        Show heatmap overlay
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-info-circle me-2"></i>Legend
                            </h6>

                            <div class="heatmap-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ff0000;"></div>
                                    <span>High delivery density</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ffaa00;"></div>
                                    <span>Medium delivery density</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #00ff00;"></div>
                                    <span>Low delivery density</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-marker">
                                        <i class="fas fa-map-marker-alt" style="color: #007bff;"></i>
                                    </div>
                                    <span>Delivery locations</span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Tip:</strong> Click on markers for detailed delivery information.
                                    Use the controls to adjust visualization.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Row: Filters -->
                <div class="row g-4 mt-2">
                    <!-- Status Filters -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-filter me-2"></i>Status Filters
                            </h6>

                            <div class="mb-3">
                                <label class="form-label">Filter by Status</label>
                                <select class="form-select" id="status-filter">
                                    <option value="">All Orders</option>
                                    <option value="completed">Completed Orders</option>
                                    <option value="cancelled">Cancelled Orders</option>
                                    <option value="partially_delivered">Partially Delivered Orders</option>
                                    <option value="pending">Pending Orders</option>
                                </select>
                                <small class="text-muted">Click on status cards above to filter quickly</small>
                            </div>
                        </div>
                    </div>

                    <!-- Rider Filter -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-user me-2"></i>Rider Filter
                            </h6>

                            <div class="mb-3">
                                <label class="form-label">Filter by Rider</label>
                                <select class="form-select" id="rider-filter" data-bs-toggle="dropdown">
                                    <option value="">All Riders</option>
                                </select>
                                <small class="text-muted">Search and select a specific rider</small>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Filter -->
                    <div class="col-lg-4">
                        <div class="filter-section">
                            <h6 class="filter-section-title">
                                <i class="fas fa-truck me-2"></i>Vehicle Filter
                            </h6>

                            <div class="mb-3">
                                <label class="form-label">Filter by Vehicle</label>
                                <select class="form-select" id="vehicle-filter">
                                    <option value="">All Vehicles</option>
                                </select>
                                <small class="text-muted">Search and select a specific vehicle</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Actions -->
                <div class="filters-actions mt-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary" id="apply-controls-btn">
                                <i class="fas fa-sync me-1"></i>
                                Update Heatmap
                            </button>
                            <button class="btn btn-outline-secondary" id="reset-view-btn">
                                <i class="fas fa-home me-1"></i>
                                Reset View
                            </button>
                            <button class="btn btn-outline-warning" id="clear-filters-btn">
                                <i class="fas fa-eraser me-1"></i>
                                Clear Filters
                            </button>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-info" id="fullscreen-btn">
                                <i class="fas fa-expand" id="fullscreen-icon"></i>
                                <span id="fullscreen-text">Fullscreen</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Messages Container -->
        <div id="control-messages" class="mt-3"></div>
    </div>
</div>


<!-- Map Container -->
<div class="row" style="    padding-bottom: 5rem;">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div id="heatmap-container" style="height: 600px; position: relative;">
                    <div id="map" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Details Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">
                    <i class="fas fa-map-marker-alt me-2"></i>Location Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="locationModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading location details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.heatmap-legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    border: 1px solid #ddd;
}

.legend-marker {
    width: 16px;
    text-align: center;
}

.gm-popup-content {
    margin: 8px;
    line-height: 1.6;
    max-width: 350px;
}

.popup-header {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    border-bottom: 1px solid #eee;
    padding-bottom: 4px;
}

.popup-stats {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
    margin: 8px 0;
}

.popup-stat {
    text-align: center;
    padding: 4px;
    background: #f8f9fa;
    border-radius: 4px;
}

.popup-stat-value {
    font-weight: 600;
    color: #333;
    display: block;
}

.popup-stat-label {
    font-size: 0.8em;
    color: #666;
}

#heatmap-container.fullscreen {
    position: fixed !important;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999;
    background: white;
}

#heatmap-container.fullscreen #map {
    height: 100vh !important;
}

/* Google Maps custom styles */
.gm-style-iw {
    padding: 0;
    border-radius: 8px;
}

.gm-style-iw-c {
    padding: 12px;
}

.gm-style-iw-d {
    overflow: auto !important;
}

/* Modern loading animation */
@keyframes heatmapPulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}

/* Performance optimization for Google Maps */
#map {
    transform: translateZ(0);
    will-change: transform;
}

/* Loading overlay animation */
#loading-overlay {
    transition: opacity 0.3s ease-in-out;
}

#loading-overlay .spinner-border {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Status card filtering styles - completely override base styles */
.stat-card.clickable-stat {
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    position: relative !important;
    border: 2px solid transparent !important;
}

.stat-card.clickable-stat * {
    cursor: pointer !important;
}

.stat-card.clickable-stat:hover:not(.active-filter) {
    transform: translateY(-4px) !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 2px rgba(59, 130, 246, 0.4) !important;
    cursor: pointer !important;
    border: 2px solid rgba(59, 130, 246, 0.4) !important;
    background: rgba(59, 130, 246, 0.02) !important;
}

.stat-card.clickable-stat:hover .stat-filter-hint {
    opacity: 1;
    transform: translateY(0);
}

/* Create a completely new glow effect using outline and box-shadow */
.stat-card-glowing {
    outline: 3px solid #007bff !important;
    outline-offset: 2px !important;
    background: rgba(0, 123, 255, 0.15) !important;
    position: relative !important;
    transform: scale(1.02) translateY(-2px) !important;
    transition: none !important;
    z-index: 999 !important;
    animation: pulseGlow 2s ease-in-out infinite alternate !important;
}

/* Use both outline and multiple box shadows for maximum visibility */
@keyframes pulseGlow {
    0% {
        outline-color: rgba(0, 123, 255, 0.8);
        box-shadow:
            0 0 10px rgba(0, 123, 255, 0.6),
            0 0 20px rgba(0, 123, 255, 0.4),
            0 0 30px rgba(0, 123, 255, 0.3),
            inset 0 0 10px rgba(0, 123, 255, 0.1);
        filter: drop-shadow(0 0 10px rgba(0, 123, 255, 0.5));
    }
    100% {
        outline-color: rgba(0, 123, 255, 1);
        box-shadow:
            0 0 15px rgba(0, 123, 255, 0.8),
            0 0 25px rgba(0, 123, 255, 0.6),
            0 0 35px rgba(0, 123, 255, 0.4),
            inset 0 0 15px rgba(0, 123, 255, 0.2);
        filter: drop-shadow(0 0 15px rgba(0, 123, 255, 0.7));
    }
}

.stat-card-glowing .stat-value {
    color: #007bff !important;
    font-weight: 700 !important;
}

.stat-card-glowing .stat-filter-hint {
    color: #007bff !important;
    opacity: 1 !important;
    font-weight: 600 !important;
}

/* Force override any conflicting styles */
.stat-card.clickable-stat.stat-card-glowing {
    border: none !important;
}

.stat-card.clickable-stat.stat-card-glowing:hover {
    transform: scale(1.03) translateY(-3px) !important;
}

.stat-filter-hint {
    font-size: 0.65rem;
    color: #6b7280;
    text-align: center;
    margin-top: 4px;
    opacity: 0.7;
    transition: all 0.2s ease;
    transform: translateY(-2px);
    font-weight: 500;
}

.stat-card.active-filter .stat-filter-hint {
    color: var(--primary-color);
    opacity: 1;
    font-weight: 600;
}
</style>
{% endblock %}

{% block scripts %}

<script>
// Google Maps Heatmap dashboard state
let currentFilters = {
    date: '{{ selected_date }}', // Initialize with server date
    date_from: '{{ date_from or "" }}', // Date range start
    date_to: '{{ date_to or "" }}', // Date range end
    day_filter: '{{ day_filter or "" }}', // Optional day within range
    aggregation_level: 'area',
    status_filter: '',
    rider_filter: '',
    vehicle_filter: ''
};

let map = null;
let heatmapCircles = []; // Store heatmap circles separately
let locationMarkers = []; // Store location markers separately
let infoWindow = null;
let heatmapData = [];

// Function to get the current date from the orders page (localStorage or default)
function getOrdersPageDate() {
    // Try to get the date from localStorage (set by orders page)
    const ordersDate = localStorage.getItem('selectedDate');
    if (ordersDate && ordersDate !== 'null' && ordersDate !== '') {
        console.log('Using date from orders page localStorage:', ordersDate);
        return ordersDate;
    }

    // Fallback to server-provided date
    const serverDate = '{{ selected_date }}';
    console.log('Using server-provided date:', serverDate);
    return serverDate;
}

// DOM Content Loaded - Wait for Google Maps to initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 === DOM READY - WAITING FOR GOOGLE MAPS ===');

    // Show loading while waiting for Google Maps API
    showLoading();

    console.log('📡 Google Maps will be loaded dynamically...');
});

function initializeControlsPanel() {
    // Toggle controls panel
    const controlsToggle = document.getElementById('controls-toggle');
    const controlsContent = document.getElementById('controls-content');
    const chevron = document.getElementById('controls-chevron');
    const toggleText = document.getElementById('controls-toggle-text');

    controlsToggle.addEventListener('click', function() {
        const isHidden = controlsContent.style.display === 'none';

        if (isHidden) {
            controlsContent.style.display = 'block';
            chevron.className = 'fas fa-chevron-up';
            toggleText.textContent = 'Hide Controls';
        } else {
            controlsContent.style.display = 'none';
            chevron.className = 'fas fa-chevron-down';
            toggleText.textContent = 'Show Controls';
        }
    });

    // Control event handlers
    document.getElementById('apply-controls-btn').addEventListener('click', applyControls);
    document.getElementById('reset-view-btn').addEventListener('click', resetMapView);
    document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
    document.getElementById('clear-filters-btn').addEventListener('click', clearAllFilters);

    // Intensity slider
    const intensitySlider = document.getElementById('intensity-slider');
    const intensityValue = document.getElementById('intensity-value');

    intensitySlider.addEventListener('input', function() {
        intensityValue.textContent = this.value;
    });

    // Display options
    document.getElementById('show-markers').addEventListener('change', toggleMarkers);
    document.getElementById('show-heatmap').addEventListener('change', toggleHeatmapLayer);

    // Filter event listeners
    document.getElementById('status-filter').addEventListener('change', function() {
        console.log('📋 Dropdown status filter changed to:', this.value);
        currentFilters.status_filter = this.value;
        loadHeatmapData();
        // Don't call updateFilterUI here - it will be called after loadHeatmapData completes
    });

    document.getElementById('rider-filter').addEventListener('change', function() {
        currentFilters.rider_filter = this.value;
        loadHeatmapData();
    });

    document.getElementById('vehicle-filter').addEventListener('change', function() {
        currentFilters.vehicle_filter = this.value;
        loadHeatmapData();
    });
}

// Initialize Google Maps (called by the API callback)
function initMap() {
    console.log('🗺️ Starting Google Maps initialization...');

    try {
        // Initialize Google Maps
        console.log('📍 Creating Google Maps instance...');
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: { lat: 28.6139, lng: 77.2090 }, // Default to Delhi
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [
                {
                    featureType: 'poi',
                    elementType: 'labels',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        console.log('✓ Google Maps created successfully');

        // Initialize InfoWindow
        infoWindow = new google.maps.InfoWindow();

        // Initialize the heatmap dashboard after map is ready
        google.maps.event.addListenerOnce(map, 'idle', function() {
            console.log('✅ Google Maps is ready and rendered');
            initializeHeatmapDashboard();
        });

        // Ensure map resize on window resize
        window.addEventListener('resize', function() {
            setTimeout(() => {
                if (map) {
                    google.maps.event.trigger(map, 'resize');
                }
            }, 100);
        });

    } catch (error) {
        console.error('❌ Failed to create Google Maps:', error);
        return;
    }

    console.log('✓ Google Maps initialization completed');
}

// Initialize heatmap dashboard after map is ready
function initializeHeatmapDashboard() {
    console.log('🚀 === GOOGLE MAPS HEATMAP INITIALIZATION STARTED ===');

    // Set the proper date first
    currentFilters.date = getOrdersPageDate();
    console.log('✓ Initialized with date:', currentFilters.date);

    console.log('📋 Initializing controls panel...');
    initializeControlsPanel();
    console.log('✓ Controls panel initialized');

    // Update the displayed date from orders page
    console.log('📅 Updating displayed date...');
    updateDisplayedDate();
    console.log('✓ Date display updated');

    // Load filter options
    console.log('📋 Loading filter options...');
    loadFilterOptions();
    console.log('✓ Filter options loading initiated');

    // Load initial heatmap data
    console.log('📊 Loading initial heatmap data...');
    loadHeatmapData().then(() => {
        console.log('✓ Initial heatmap data loading completed');
        // Initialize UI state after data is loaded
        updateFilterUI();
    }).catch((error) => {
        console.error('❌ Failed to load initial heatmap data:', error);
        hideLoading();
        showError('Failed to load heatmap data. Please try refreshing the page.');
    });

    // Update last updated time
    console.log('⏰ Updating last updated time...');
    updateLastUpdatedTime();
    console.log('✓ Last updated time set');

    console.log('🎉 === GOOGLE MAPS HEATMAP INITIALIZATION COMPLETED ===');

    // Ultimate Loading Failsafe - Ensure loading NEVER gets stuck
    setTimeout(() => {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay && getComputedStyle(loadingOverlay).display !== 'none') {
            console.warn('🚨 ULTIMATE FAILSAFE: Loading was still visible after initialization!');
            loadingOverlay.style.display = 'none';
            console.log('✅ Failsafe: Loading overlay force-hidden');
        }
    }, 1000);

    // Listen for storage events to update when orders page changes date
    window.addEventListener('storage', async function(e) {
        if (e.key === 'selectedDate' && e.newValue !== e.oldValue) {
            console.log('Date changed in orders page from', e.oldValue, 'to', e.newValue);
            currentFilters.date = e.newValue;
            updateDisplayedDate();
            // Reload heatmap data when date changes
            await loadHeatmapData();
        }
    });

    // Listen for page visibility changes to refresh when user returns to tab
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('Tab became visible, refreshing heatmap...');
            refreshHeatmap();
        }
    });
}

// Update day filter when date is changed
function updateDateFilter(selectedDate) {
    currentFilters.day_filter = selectedDate;

    // Save to localStorage for navigation
    localStorage.setItem('selectedDayFilter', selectedDate);

    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('day_filter', selectedDate);
    history.replaceState(null, '', url);

    // Reload data
    loadHeatmapData();
}

function updateDisplayedDate() {
    const displayDateField = document.getElementById('display-date');
    if (displayDateField) {
        displayDateField.value = currentFilters.date;
    }
}

async function loadHeatmapData() {
    console.log('📊 === STARTING HEATMAP DATA LOADING ===');
    try {
        console.log('📋 Current filters:', currentFilters);

        console.log('⏳ Showing loading overlay...');
        showLoading();

        // Build query parameters
        const params = new URLSearchParams();
        if (currentFilters.date_from && currentFilters.date_to) {
            params.append('date_from', currentFilters.date_from);
            params.append('date_to', currentFilters.date_to);
            if (currentFilters.day_filter) {
                params.append('day_filter', currentFilters.day_filter);
            }
        } else if (currentFilters.date) {
            params.append('date', currentFilters.date);
        }
        params.append('aggregation_level', currentFilters.aggregation_level);

        // Add filter parameters
        if (currentFilters.status_filter) {
            params.append('status_filter', currentFilters.status_filter);
        }
        if (currentFilters.rider_filter) {
            params.append('rider_filter', currentFilters.rider_filter);
        }
        if (currentFilters.vehicle_filter) {
            params.append('vehicle_filter', currentFilters.vehicle_filter);
        }

        const apiUrl = `/api/heatmap?${params}`;
        console.log('🌐 API URL:', apiUrl);
        console.log('📤 Making fetch request...');

        const startTime = Date.now();
        const response = await fetch(apiUrl);
        const fetchTime = Date.now() - startTime;
        console.log(`✓ Fetch completed in ${fetchTime}ms`);

        console.log('📥 Response status:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        console.log('📄 Parsing JSON response...');
        const result = await response.json();
        console.log('✓ JSON parsed successfully');

        console.log('📊 API Response structure:', {
            success: result.success,
            heatmapDataLength: result.heatmap_data ? result.heatmap_data.length : 'undefined',
            hasStatistics: !!result.statistics,
            needsExtraction: result.needs_coordinate_extraction,
            ordersWithoutCoords: result.orders_without_coordinates,
            error: result.error
        });

        if (result.success) {
            console.log('✅ API call successful');
            heatmapData = result.heatmap_data;
            console.log('📊 Heatmap data loaded:', heatmapData.length, 'points');

            console.log('📈 Displaying statistics...');
            displayHeatmapStats(result.statistics);
            console.log('✓ Statistics displayed');

            // Check if coordinate extraction is needed
            if (result.needs_coordinate_extraction && result.orders_without_coordinates > 0) {
                console.log('⚠️ Coordinate extraction needed for', result.orders_without_coordinates, 'orders');
                showCoordinateExtractionPrompt(result.orders_without_coordinates, currentFilters.date);
                hideLoading();
                console.log('✓ Loading hidden (extraction prompt shown)');
            } else {
                console.log('🗺️ Updating map visualization...');
                updateMapVisualization();
                console.log('✓ Map visualization updated');
                hideLoading();
                console.log('✓ Loading hidden');
            }
            console.log('✅ Successfully loaded', heatmapData.length, 'heatmap points');
        } else {
            console.error('❌ API returned error:', result.error);
            showError('Failed to load heatmap data: ' + (result.error || 'Unknown error'));
            heatmapData = [];
            updateMapVisualization();
            hideLoading();
            console.log('✓ Loading hidden (after error)');
        }

    } catch (error) {
        console.error('❌ Exception during heatmap data loading:', error);
        console.error('Stack trace:', error.stack);
        showError('Error loading heatmap data. Please try again.');
        heatmapData = [];
        updateMapVisualization();
        hideLoading();
        console.log('✓ Loading hidden (after exception)');
    }
    console.log('📊 === HEATMAP DATA LOADING COMPLETED ===');
}

function displayHeatmapStats(stats) {
    const statsGrid = document.getElementById('heatmap-stats-grid');

    statsGrid.innerHTML = `
        <div class="stat-card hover-lift clickable-stat" data-filter="all">
            <div class="stat-icon">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-value">${stats.total_orders || 0}</div>
            <div class="stat-label">Total Orders</div>
            <div class="stat-filter-hint">Click to show all orders</div>
        </div>

        <div class="stat-card hover-lift clickable-stat" data-filter="completed">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value">${stats.completed_orders || 0}</div>
            <div class="stat-label">Completed Orders</div>
            <div class="stat-filter-hint">Click to filter by completed</div>
        </div>

        <div class="stat-card hover-lift clickable-stat" data-filter="cancelled">
            <div class="stat-icon" style="background: rgba(220, 53, 69, 0.1); color: var(--danger-color);">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-value">${stats.cancelled_orders || 0}</div>
            <div class="stat-label">Cancelled Orders</div>
            <div class="stat-filter-hint">Click to filter by cancelled</div>
        </div>

        <div class="stat-card hover-lift clickable-stat" data-filter="partially_delivered">
            <div class="stat-icon" style="background: rgba(255, 165, 0, 0.1); color: #ffa500;">
                <i class="fas fa-truck-loading"></i>
            </div>
            <div class="stat-value">${stats.partially_delivered_orders || 0}</div>
            <div class="stat-label">Partially Delivered</div>
            <div class="stat-filter-hint">Click to filter by partially delivered</div>
        </div>

        <div class="stat-card hover-lift clickable-stat" data-filter="pending">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value">${stats.pending_orders || 0}</div>
            <div class="stat-label">Pending Orders</div>
            <div class="stat-filter-hint">Click to filter by pending</div>
        </div>

        <div class="stat-card hover-lift">
            <div class="stat-icon" style="background: rgba(139, 69, 19, 0.1); color: #8b4513;">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="stat-value">${stats.unique_locations || 0}</div>
            <div class="stat-label">Delivery Locations</div>
        </div>

        <div class="stat-card hover-lift">
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--primary-color);">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-value">${stats.completion_rate || 0}%</div>
            <div class="stat-label">Completion Rate</div>
        </div>
    `;

    // Add click event listeners for status filtering
    document.querySelectorAll('.clickable-stat').forEach(card => {
        card.addEventListener('click', function() {
            const filter = this.dataset.filter;
            applyStatusFilter(filter);
        });
    });

    // Apply current filter UI state after cards are created
    // Use requestAnimationFrame for better timing
    requestAnimationFrame(() => {
        setTimeout(() => {
            console.log('🎨 Applying filter UI after cards rendered');
            updateFilterUI();
        }, 50);
    });
}

function updateMapVisualization() {
    console.log('🗺️ === STARTING GOOGLE MAPS VISUALIZATION UPDATE ===');
    console.log('📊 Heatmap data points:', heatmapData ? heatmapData.length : 'null/undefined');

    // Clear existing layers
    console.log('🧹 Clearing existing layers...');

    // Clear heatmap circles
    heatmapCircles.forEach(circle => {
        circle.setMap(null);
    });
    heatmapCircles = [];

    // Clear location markers
    locationMarkers.forEach(marker => {
        marker.setMap(null);
    });
    locationMarkers = [];
    console.log('✓ Layers cleared');

    if (!heatmapData || heatmapData.length === 0) {
        console.log('⚠️ No heatmap data available - centering on default location');
        // Center map on Delhi when no data
        map.setCenter({ lat: 28.6139, lng: 77.2090 });
        map.setZoom(10);
        console.log('✓ Map centered on default location');
        return;
    }

    console.log('✓ Have', heatmapData.length, 'data points to visualize');

    // Log sample of first data point for debugging
    if (heatmapData.length > 0) {
        const samplePoint = heatmapData[0];
        console.log('📍 Sample data point:', {
            latitude: samplePoint.latitude,
            longitude: samplePoint.longitude,
            intensity: samplePoint.intensity,
            order_count: samplePoint.order_count,
            location_name: samplePoint.location_name
        });
    }

    // Add heatmap layer if enabled
    console.log('🔥 Checking heatmap layer option...');
    const showHeatmapCheckbox = document.getElementById('show-heatmap');
    if (showHeatmapCheckbox && showHeatmapCheckbox.checked) {
        console.log('✓ Heatmap layer enabled - adding heatmap layer');
        addHeatmapLayer();
    } else {
        console.log('ℹ️ Heatmap layer disabled');
    }

    // Add markers if enabled
    console.log('🔍 Checking markers option...');
    const showMarkersCheckbox = document.getElementById('show-markers');
    if (showMarkersCheckbox && showMarkersCheckbox.checked) {
        console.log('✓ Markers enabled - adding markers');
        addMarkers();
    } else {
        console.log('ℹ️ Markers disabled');
    }

    // Fit map to data bounds if we have data
    console.log('🎯 Fitting map to data bounds...');
    if (heatmapData.length > 0) {
        try {
            const bounds = new google.maps.LatLngBounds();
            heatmapData.forEach(point => {
                bounds.extend({ lat: point.latitude, lng: point.longitude });
            });
            map.fitBounds(bounds, { top: 20, left: 20, bottom: 20, right: 20 });
            console.log('✓ Map fitted to bounds');
        } catch (error) {
            console.error('❌ Error fitting bounds:', error);
        }
    }

    console.log('🗺️ === GOOGLE MAPS VISUALIZATION UPDATE COMPLETED ===');
}

let heatmapLayer = null;

function addHeatmapLayer() {
    console.log('🔥 === ADDING GOOGLE MAPS HEATMAP LAYER ===');

    if (!heatmapData || heatmapData.length === 0) {
        console.log('⚠️ No heatmap data available');
        return;
    }

    console.log('📊 Processing', heatmapData.length, 'data points for Google Maps heatmap');

    // Clear existing heatmap layer
    if (heatmapLayer) {
        heatmapLayer.setMap(null);
        heatmapLayer = null;
    }

    console.log('⚙️ Getting intensity setting...');
    const intensitySlider = document.getElementById('intensity-slider');
    const intensity = intensitySlider ? parseFloat(intensitySlider.value) : 1.0;
    console.log('📊 Intensity setting:', intensity);

    // Prepare heatmap data points for Google Maps
    console.log('📍 Preparing Google Maps heatmap points...');
    const heatPoints = heatmapData.map(point => {
        return {
            location: new google.maps.LatLng(point.latitude, point.longitude),
            weight: point.intensity * intensity
        };
    });
    console.log('✓ Prepared', heatPoints.length, 'heat points');

    try {
        console.log('🔥 Creating Google Maps heatmap layer...');

        // Create Google Maps HeatmapLayer using the visualization library
        heatmapLayer = new google.maps.visualization.HeatmapLayer({
            data: heatPoints,
            map: map
        });

        // Configure heatmap options to match your reference image
        const maxWeight = Math.max(...heatmapData.map(p => p.intensity)) * intensity;

        heatmapLayer.setOptions({
            radius: 60,  // Larger radius for smoother blending
            opacity: 0.7,  // Good visibility while showing map underneath
            maxIntensity: maxWeight,
            gradient: [
                'rgba(0, 255, 0, 0)',       // Transparent (no data)
                'rgba(0, 255, 0, 0.2)',     // Light green (very low density)
                'rgba(0, 255, 0, 0.5)',     // Green (low density)
                'rgba(255, 255, 0, 0.7)',   // Yellow (medium-low density)
                'rgba(255, 165, 0, 0.8)',   // Orange (medium density)
                'rgba(255, 69, 0, 0.9)',    // Orange red (high density)
                'rgba(255, 0, 0, 1)'        // Red (maximum density)
            ],
            dissipating: true  // Allow natural heat dissipation
        });

        console.log('✅ Google Maps heatmap layer added successfully!');
        console.log('📊 Heatmap configured with', heatPoints.length, 'points, max weight:', maxWeight);

    } catch (error) {
        console.error('❌ Error creating Google Maps heatmap layer:', error);
        console.error('Stack trace:', error.stack);
        console.log('🔄 Falling back to circle visualization...');
        addHeatCircles();
    }

    console.log('🔥 === GOOGLE MAPS HEATMAP LAYER ADDITION COMPLETED ===');
}

function addHeatCircles() {
    // True heatmap visualization using overlapping circles with radial gradients
    if (!heatmapData || heatmapData.length === 0) return;

    const intensity = parseFloat(document.getElementById('intensity-slider').value);
    const maxIntensity = Math.max(...heatmapData.map(p => p.intensity));

    console.log('🔥 Creating true heatmap visualization with radial gradients...');

    heatmapData.forEach(point => {
        const normalizedIntensity = (point.intensity / maxIntensity) * intensity;
        const baseRadius = 300; // Base radius in meters for heatmap effect
        const radius = Math.min(Math.max(normalizedIntensity * baseRadius * 1.5, baseRadius * 0.4), baseRadius * 2);

        // Create heatmap color based on intensity (true heatmap colors)
        let heatColor, heatIntensity;

        if (normalizedIntensity > 0.8) {
            heatColor = '#ff0000'; // Pure red for maximum heat
            heatIntensity = 0.8;
        } else if (normalizedIntensity > 0.6) {
            heatColor = '#ff4500'; // Orange red for high heat
            heatIntensity = 0.7;
        } else if (normalizedIntensity > 0.4) {
            heatColor = '#ffa500'; // Orange for medium heat
            heatIntensity = 0.6;
        } else if (normalizedIntensity > 0.2) {
            heatColor = '#ffff00'; // Yellow for low-medium heat
            heatIntensity = 0.5;
        } else {
            heatColor = '#00ff00'; // Green for low heat
            heatIntensity = 0.4;
        }

        // Create multiple concentric circles to simulate heatmap gradient
        const heatCircles = [];

        // Layer 1: Outermost circle (largest, most transparent)
        heatCircles.push(new google.maps.Circle({
            strokeColor: 'transparent',
            strokeOpacity: 0,
            strokeWeight: 0,
            fillColor: heatColor,
            fillOpacity: heatIntensity * 0.1,
            map: map,
            center: { lat: point.latitude, lng: point.longitude },
            radius: radius * 2
        }));

        // Layer 2: Second circle
        heatCircles.push(new google.maps.Circle({
            strokeColor: 'transparent',
            strokeOpacity: 0,
            strokeWeight: 0,
            fillColor: heatColor,
            fillOpacity: heatIntensity * 0.2,
            map: map,
            center: { lat: point.latitude, lng: point.longitude },
            radius: radius * 1.5
        }));

        // Layer 3: Third circle
        heatCircles.push(new google.maps.Circle({
            strokeColor: 'transparent',
            strokeOpacity: 0,
            strokeWeight: 0,
            fillColor: heatColor,
            fillOpacity: heatIntensity * 0.4,
            map: map,
            center: { lat: point.latitude, lng: point.longitude },
            radius: radius * 1.2
        }));

        // Layer 4: Inner circle
        heatCircles.push(new google.maps.Circle({
            strokeColor: 'transparent',
            strokeOpacity: 0,
            strokeWeight: 0,
            fillColor: heatColor,
            fillOpacity: heatIntensity * 0.6,
            map: map,
            center: { lat: point.latitude, lng: point.longitude },
            radius: radius * 0.8
        }));

        // Layer 5: Core circle (smallest, most intense)
        heatCircles.push(new google.maps.Circle({
            strokeColor: 'transparent',
            strokeOpacity: 0,
            strokeWeight: 0,
            fillColor: heatColor,
            fillOpacity: heatIntensity,
            map: map,
            center: { lat: point.latitude, lng: point.longitude },
            radius: radius * 0.4
        }));

        // Store heatmap circles for cleanup
        heatmapCircles.push(...heatCircles);

        // Add click listener to all heat circles for this location
        heatCircles.forEach(circle => {
            circle.addListener('click', function() {
                const infoContent = createPopupContent(point);
                infoWindow.setContent(`<div class="gm-popup-content">${infoContent}</div>`);
                infoWindow.setPosition({ lat: point.latitude, lng: point.longitude });
                infoWindow.open(map);

                // Also show detailed modal
                showLocationDetails(point.latitude, point.longitude, point.location_name);
            });
        });
    });

    console.log('✅ Created true heatmap visualization with', heatmapData.length, 'heat zones');
}

function addMarkers() {
    if (!heatmapData || heatmapData.length === 0) return;

    console.log('🔍 Adding Google Maps markers...');

    heatmapData.forEach(point => {
        // Determine marker color based on delivery status
        let markerColor = '#007bff'; // Default blue
        if (point.completion_rate >= 80) {
            markerColor = '#28a745'; // Green for high completion
        } else if (point.completion_rate >= 50) {
            markerColor = '#ffc107'; // Yellow for medium completion
        } else {
            markerColor = '#dc3545'; // Red for low completion
        }

        // Create modern marker using AdvancedMarkerElement if available, fallback to classic Marker
        const markerSize = Math.min(Math.max(point.order_count / 2, 8), 25);
        let marker;

        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            // Use modern AdvancedMarkerElement
            const markerDiv = document.createElement('div');
            markerDiv.style.width = `${markerSize * 2}px`;
            markerDiv.style.height = `${markerSize * 2}px`;
            markerDiv.style.borderRadius = '50%';
            markerDiv.style.backgroundColor = markerColor;
            markerDiv.style.border = '2px solid white';
            markerDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
            markerDiv.style.cursor = 'pointer';
            markerDiv.title = point.location_name || 'Delivery Location';

            marker = new google.maps.marker.AdvancedMarkerElement({
                position: { lat: point.latitude, lng: point.longitude },
                map: map,
                content: markerDiv,
                title: point.location_name || 'Delivery Location'
            });
        } else {
            // Fallback to classic Marker
            marker = new google.maps.Marker({
                position: { lat: point.latitude, lng: point.longitude },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: markerColor,
                    fillOpacity: 0.8,
                    strokeColor: 'white',
                    strokeWeight: 2,
                    scale: markerSize
                },
                title: point.location_name || 'Delivery Location'
            });
        }

        // Create info window content
        const infoContent = createPopupContent(point);

        // Add click listener to show info window
        marker.addListener('click', function() {
            infoWindow.setContent(`<div class="gm-popup-content">${infoContent}</div>`);
            infoWindow.open(map, marker);

            // Also show detailed modal
            showLocationDetails(point.latitude, point.longitude, point.location_name);
        });

        locationMarkers.push(marker);
    });

    console.log('✓ Added', locationMarkers.length, 'Google Maps markers');
}

function createPopupContent(point) {
    const locationName = point.location_name || point.area_name || point.city_name || 'Unknown Location';
    const totalValue = point.orders ? point.orders.reduce((sum, order) => sum + (order.order_value || 0), 0) : 0;
    const uniqueRiders = point.orders ? new Set(point.orders.map(o => o.rider_name).filter(Boolean)).size : 0;
    const uniqueVehicles = point.orders ? new Set(point.orders.map(o => o.vehicle_registration).filter(Boolean)).size : 0;

    return `
        <div class="popup-header">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${locationName}
        </div>

        <div class="popup-stats">
            <div class="popup-stat">
                <span class="popup-stat-value">${point.order_count}</span>
                <span class="popup-stat-label">Orders</span>
            </div>
            <div class="popup-stat">
                <span class="popup-stat-value">${point.completion_rate}%</span>
                <span class="popup-stat-label">Completed</span>
            </div>
            <div class="popup-stat">
                <span class="popup-stat-value">${point.total_quantity}</span>
                <span class="popup-stat-label">Total Items</span>
            </div>
            <div class="popup-stat">
                <span class="popup-stat-value">${point.delivered_quantity}</span>
                <span class="popup-stat-label">Delivered</span>
            </div>
            <div class="popup-stat">
                <span class="popup-stat-value">${uniqueRiders}</span>
                <span class="popup-stat-label">Riders</span>
            </div>
            <div class="popup-stat">
                <span class="popup-stat-value">${uniqueVehicles}</span>
                <span class="popup-stat-label">Vehicles</span>
            </div>
        </div>

        ${totalValue > 0 ? `
        <div class="text-center mt-2 mb-2">
            <small class="text-muted">
                <strong>Total Value:</strong> $${totalValue.toFixed(2)}
            </small>
        </div>
        ` : ''}

        <div class="text-center mt-2">
            <small class="text-muted">Click marker for detailed information</small>
        </div>
    `;
}

async function showLocationDetails(latitude, longitude, locationName) {
    const modal = new bootstrap.Modal(document.getElementById('locationModal'));
    const modalTitle = document.getElementById('locationModalLabel');
    const modalBody = document.getElementById('locationModalBody');

    modalTitle.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>${locationName || 'Location Details'}`;
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading location details...</p>
        </div>
    `;

    modal.show();

    try {
        const response = await fetch(`/api/heatmap/location-details?latitude=${latitude}&longitude=${longitude}`);
        const result = await response.json();

        if (result.success) {
            modalBody.innerHTML = createLocationDetailsContent(result);
        } else {
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load location details: ${result.error || 'Unknown error'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading location details:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading location details. Please try again.
            </div>
        `;
    }
}

function createLocationDetailsContent(data) {
    const { orders, summary } = data;

    let content = `
        <!-- Summary Section -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Delivery Summary</h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-primary">${summary.order_count}</div>
                            <small class="text-muted">Total Orders</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-success">${summary.completed_orders}</div>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-warning">${summary.total_quantity}</div>
                            <small class="text-muted">Total Items</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="fw-bold text-info">${summary.delivery_rate}%</div>
                            <small class="text-muted">Delivery Rate</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (orders && orders.length > 0) {
        content += `
            <!-- Orders List -->
            <div class="row">
                <div class="col-12">
                    <h6 class="mb-3"><i class="fas fa-list me-2"></i>Order Details</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Order ID</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                    <th>Rider</th>
                                    <th>Vehicle</th>
                                    <th>Items</th>
                                    <th>Value</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        orders.slice(0, 10).forEach(order => {
            const statusClass = order.status === 'COMPLETED' ? 'success' :
                              order.status === 'CANCELLED' ? 'danger' : 'warning';

            const itemsCount = order.line_items ? order.line_items.length : (order.total_items || 0);
            const totalQuantity = order.line_items ?
                order.line_items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
            const orderValue = order.order_value || 0;
            const orderDate = order.date ? new Date(order.date).toLocaleDateString() : 'N/A';

            content += `
                <tr>
                    <td>
                        <small class="font-monospace">${order.id.length > 12 ? order.id.substring(0, 12) + '...' : order.id}</small>
                    </td>
                    <td>
                        <span class="badge bg-${statusClass}">${order.status}</span>
                    </td>
                    <td>
                        <small>${order.location_name || order.location_city || 'N/A'}</small>
                    </td>
                    <td>
                        <small>${order.rider_name || 'N/A'}</small>
                    </td>
                    <td>
                        <small>${order.vehicle_registration || 'N/A'}</small>
                    </td>
                    <td>
                        <small>${itemsCount} items${totalQuantity > 0 ? ` (${totalQuantity} qty)` : ''}</small>
                    </td>
                    <td>
                        <small>${orderValue > 0 ? '$' + orderValue.toFixed(2) : 'N/A'}</small>
                    </td>
                    <td>
                        <small>${orderDate}</small>
                    </td>
                </tr>
            `;
        });

        content += `
                            </tbody>
                        </table>
                    </div>
        `;

        if (orders.length > 10) {
            content += `<p class="text-muted small">Showing first 10 orders out of ${orders.length} total orders.</p>`;
        }

        content += `
                </div>
            </div>
        `;
    }

    return content;
}

function applyControls() {
    // Update filters
    currentFilters.aggregation_level = document.getElementById('aggregation-level').value;
    currentFilters.status_filter = document.getElementById('status-filter').value;
    currentFilters.rider_filter = document.getElementById('rider-filter').value;
    currentFilters.vehicle_filter = document.getElementById('vehicle-filter').value;

    // Reload heatmap data with new settings
    loadHeatmapData();

    showSuccess('Heatmap updated successfully');
}

function applyStatusFilter(status) {
    console.log('🎯 Applying status filter:', status);

    // Handle "all" filter case - reset the status filter
    if (status === 'all') {
        currentFilters.status_filter = '';
        document.getElementById('status-filter').value = '';
        showSuccess('Showing all orders');
    } else {
        // Update the status filter dropdown
        const statusSelect = document.getElementById('status-filter');
        statusSelect.value = status;

        // Update current filters
        currentFilters.status_filter = status;
        showSuccess(`Filtered by ${status} orders`);
    }

    // Reload heatmap data - UI will be updated after data loads and cards are rendered
    loadHeatmapData();
}

function updateFilterUI() {
    console.log('🎨 Updating filter UI, current status filter:', currentFilters.status_filter);

    // Remove glow effect from all cards using JavaScript
    document.querySelectorAll('.stat-card').forEach(card => {
        removeGlowEffect(card);
        console.log('Removed glow from:', card.dataset.filter);
    });

    // Add glow effect to the selected filter card
    if (currentFilters.status_filter) {
        const activeCard = document.querySelector(`[data-filter="${currentFilters.status_filter}"]`);
        if (activeCard) {
            applyGlowEffect(activeCard);
            console.log('✅ Applied glow to:', currentFilters.status_filter);
        } else {
            console.log('❌ Could not find card for filter:', currentFilters.status_filter);
        }
    } else {
        // If no status filter, highlight the "all" card
        const allCard = document.querySelector('[data-filter="all"]');
        if (allCard) {
            applyGlowEffect(allCard);
            console.log('✅ Applied glow to "all" card');
        }
    }
}

function applyGlowEffect(card) {
    // Remove any existing classes first
    card.classList.remove('active-filter', 'stat-card-glowing');

    // Apply subtle glow effect using inline styles (much gentler design)
    card.style.border = '2px solid #007bff';
    card.style.background = 'rgba(0, 123, 255, 0.08)';
    card.style.transform = 'translateY(-1px)';
    card.style.zIndex = '10';
    card.style.position = 'relative';
    card.style.boxShadow = '0 2px 8px rgba(0, 123, 255, 0.3)';

    // Create very subtle pulsing animation
    let opacity = 0.3;
    let increasing = true;

    // Clear any existing interval
    if (card.glowInterval) {
        clearInterval(card.glowInterval);
    }

    // Start gentle pulsing animation (much slower and subtler)
    card.glowInterval = setInterval(() => {
        if (increasing) {
            opacity += 0.02;
            if (opacity >= 0.5) increasing = false;
        } else {
            opacity -= 0.02;
            if (opacity <= 0.3) increasing = true;
        }

        // Very subtle shadow pulse
        card.style.boxShadow = `0 2px 8px rgba(0, 123, 255, ${opacity})`;
    }, 100); // Slower animation (100ms instead of 50ms)

    // Update text colors (more subtle)
    const statValue = card.querySelector('.stat-value');
    const statHint = card.querySelector('.stat-filter-hint');

    if (statValue) {
        statValue.style.color = '#0056b3';
        statValue.style.fontWeight = '600';
    }

    if (statHint) {
        statHint.style.color = '#0056b3';
        statHint.style.fontWeight = '500';
        statHint.style.opacity = '1';
    }

    console.log('🌟 Subtle glow effect applied');
}

function removeGlowEffect(card) {
    // Clear animation interval
    if (card.glowInterval) {
        clearInterval(card.glowInterval);
        delete card.glowInterval;
    }

    // Remove all inline styles related to glow
    card.style.border = '';
    card.style.outline = '';
    card.style.outlineOffset = '';
    card.style.background = '';
    card.style.transform = '';
    card.style.zIndex = '';
    card.style.position = '';
    card.style.boxShadow = '';

    // Reset text colors
    const statValue = card.querySelector('.stat-value');
    const statHint = card.querySelector('.stat-filter-hint');

    if (statValue) {
        statValue.style.color = '';
        statValue.style.fontWeight = '';
    }

    if (statHint) {
        statHint.style.color = '';
        statHint.style.fontWeight = '';
        statHint.style.opacity = '';
    }

    // Remove any lingering classes
    card.classList.remove('active-filter', 'stat-card-glowing');
}

async function loadFilterOptions() {
    try {
        const params = new URLSearchParams();
        if (currentFilters.date_from && currentFilters.date_to) {
            params.append('date_from', currentFilters.date_from);
            params.append('date_to', currentFilters.date_to);
            if (currentFilters.day_filter) {
                params.append('day_filter', currentFilters.day_filter);
            }
        } else if (currentFilters.date) {
            params.append('date', currentFilters.date);
        }

        const response = await fetch(`/api/heatmap/filter-options?${params}`);
        const result = await response.json();

        if (result.success) {
            populateFilterDropdowns(result);
        } else {
            console.error('Failed to load filter options:', result.error);
        }
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

function populateFilterDropdowns(options) {
    // Populate rider dropdown
    const riderSelect = document.getElementById('rider-filter');
    riderSelect.innerHTML = '<option value="">All Riders</option>';
    options.riders.forEach(rider => {
        const option = document.createElement('option');
        option.value = rider;
        option.textContent = rider;
        riderSelect.appendChild(option);
    });

    // Populate vehicle dropdown
    const vehicleSelect = document.getElementById('vehicle-filter');
    vehicleSelect.innerHTML = '<option value="">All Vehicles</option>';
    options.vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle;
        option.textContent = vehicle;
        vehicleSelect.appendChild(option);
    });
}

function clearAllFilters() {
    // Reset all filters to default values
    currentFilters.status_filter = '';
    currentFilters.rider_filter = '';
    currentFilters.vehicle_filter = '';

    // Reset all dropdowns
    document.getElementById('status-filter').value = '';
    document.getElementById('rider-filter').value = '';
    document.getElementById('vehicle-filter').value = '';

    // Immediately remove glow from all cards using JavaScript
    document.querySelectorAll('.stat-card').forEach(card => {
        removeGlowEffect(card);
    });

    // Update UI (this will highlight "All Orders" card)
    updateFilterUI();

    // Reload heatmap data
    loadHeatmapData();

    showSuccess('All filters cleared - showing all orders');
}

function resetMapView() {
    if (map && heatmapData.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        heatmapData.forEach(point => {
            bounds.extend({ lat: point.latitude, lng: point.longitude });
        });
        map.fitBounds(bounds, { top: 20, left: 20, bottom: 20, right: 20 });
    }
}

function toggleMarkers() {
    const showMarkers = document.getElementById('show-markers').checked;

    if (showMarkers) {
        console.log('🔍 Showing location markers...');
        addMarkers();
    } else {
        console.log('🔍 Hiding location markers...');
        // Clear all location markers
        locationMarkers.forEach(marker => {
            marker.setMap(null);
        });
        locationMarkers = [];
    }
}

function toggleHeatmapLayer() {
    const showHeatmap = document.getElementById('show-heatmap').checked;

    if (showHeatmap) {
        console.log('🔥 Showing heatmap layer...');
        addHeatmapLayer();
    } else {
        console.log('🔥 Hiding heatmap layer...');
        // Clear heatmap layer
        if (heatmapLayer) {
            heatmapLayer.setMap(null);
            heatmapLayer = null;
        }
        // Clear all heatmap circles
        heatmapCircles.forEach(circle => {
            circle.setMap(null);
        });
        heatmapCircles = [];
    }
}

function toggleFullscreen() {
    const container = document.getElementById('heatmap-container');
    const button = document.getElementById('fullscreen-btn');
    const icon = document.getElementById('fullscreen-icon');
    const text = document.getElementById('fullscreen-text');

    if (container.classList.contains('fullscreen')) {
        container.classList.remove('fullscreen');
        icon.className = 'fas fa-expand';
        text.textContent = 'Fullscreen';
        document.body.style.overflow = '';
    } else {
        container.classList.add('fullscreen');
        icon.className = 'fas fa-compress';
        text.textContent = 'Exit Fullscreen';
        document.body.style.overflow = 'hidden';
    }

    // Trigger Google Maps resize
    setTimeout(() => {
        if (map) {
            google.maps.event.trigger(map, 'resize');
        }
    }, 100);
}

async function refreshHeatmap() {
    await loadHeatmapData();
    updateLastUpdatedTime();
    showSuccess('Heatmap refreshed successfully');
}

function showLoading() {
    console.log('⏳ Loading heatmap data...');
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        // Add a subtle fade-in animation
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            if (loadingOverlay.style.display === 'flex') {
                loadingOverlay.style.opacity = '1';
            }
        }, 10);
        console.log('✅ Loading overlay shown successfully');
    } else {
        console.log('ℹ️ Loading overlay not present - using console logging only');
    }
}

function hideLoading() {
    console.log('✅ Heatmap data loading completed');
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        // Add fade-out animation
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 300);
        console.log('✅ Loading overlay hidden successfully');

        // Clear force hide timeout since we successfully loaded
        if (window.clearForceHideTimeout) {
            window.clearForceHideTimeout();
        }
    } else {
        console.log('ℹ️ Loading completed - no overlay to hide');
    }
}

function showError(message) {
    const messagesDiv = document.getElementById('control-messages');
    messagesDiv.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function showSuccess(message) {
    const messagesDiv = document.getElementById('control-messages');
    messagesDiv.innerHTML = `
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        const alert = messagesDiv.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

function showInfo(message) {
    const messagesDiv = document.getElementById('control-messages');
    messagesDiv.innerHTML = `
        <div class="alert alert-info alert-dismissible fade show">
            <i class="fas fa-info-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function updateLastUpdatedTime() {
    const now = new Date();
    document.getElementById('last-updated').textContent = now.toLocaleTimeString();
}

function showCoordinateExtractionPrompt(ordersCount, date) {
    const messagesDiv = document.getElementById('control-messages');
    messagesDiv.innerHTML = `
        <div class="alert alert-warning alert-dismissible fade show">
            <i class="fas fa-map-marker-alt me-2"></i>
            <strong>Location Coordinates Missing</strong><br>
            Found ${ordersCount} orders for ${date} without location coordinates.
            <br><small class="text-muted">Click "Extract Coordinates" to fetch location data from the Locus API.</small>
            <div class="mt-2">
                <button class="btn btn-warning btn-sm me-2" onclick="extractCoordinatesForDate('${date}')">
                    <i class="fas fa-download me-1"></i>Extract Coordinates
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="dismissCoordinatePrompt()">
                    <i class="fas fa-times me-1"></i>Show Map Anyway
                </button>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="updateMapVisualization()"></button>
        </div>
    `;
}

function dismissCoordinatePrompt() {
    document.getElementById('control-messages').innerHTML = '';
    updateMapVisualization();
}

async function extractCoordinatesForDate(date) {
    const extractButton = document.querySelector('button[onclick*="extractCoordinatesForDate"]');
    if (extractButton) {
        extractButton.disabled = true;
        extractButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Extracting...';
    }

    try {
        showInfo('Extracting coordinates from Locus API. This may take a few minutes...');

        const response = await fetch('/api/orders/extract-coordinates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                date: date,
                limit: 50  // Process up to 50 orders at a time to avoid timeout
            })
        });

        const result = await response.json();

        if (result.success) {
            showSuccess(`Successfully extracted coordinates for ${result.updated_count} orders! Refreshing heatmap...`);

            // Reload heatmap data after successful extraction
            setTimeout(async () => {
                await loadHeatmapData();
            }, 1500);
        } else {
            showError(`Failed to extract coordinates: ${result.error || 'Unknown error'}`);
            updateMapVisualization(); // Show map anyway
        }

    } catch (error) {
        console.error('Error extracting coordinates:', error);
        showError('Error extracting coordinates. Please try again.');
        updateMapVisualization(); // Show map anyway
    } finally {
        if (extractButton) {
            extractButton.disabled = false;
            extractButton.innerHTML = '<i class="fas fa-download me-1"></i>Extract Coordinates';
        }
    }
}

// Auto-refresh every 5 minutes
setInterval(refreshHeatmap, 300000);
</script>

<!-- Load Google Maps API after all our code is defined -->
<script>
function loadGoogleMaps() {
    // Create script element
    const script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAjiXkHxr-Cy_AbeNNENquPcjwojBIGh-4&libraries=visualization&callback=initMap';
    script.async = true;
    script.defer = true;

    // Handle loading errors
    script.onerror = function() {
        console.error('❌ Failed to load Google Maps API');
        hideLoading();
        showError('Failed to load Google Maps API. Please check your internet connection and API key.');
    };

    // Add to head
    document.head.appendChild(script);
    console.log('📡 Google Maps API script added to DOM');
}

// Load Google Maps when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleMaps);
} else {
    loadGoogleMaps();
}
</script>
{% endblock %}