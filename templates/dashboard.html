{% extends "base.html" %}

{% block title %}Dashboard - Locus Assistant{% endblock %}

{% block content %}
<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Modern Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="text-gradient mb-2">
                    <i class="fas fa-tachometer-alt me-3"></i>Orders Dashboard
                </h1>
                <p class="text-muted mb-0">Real-time logistics management and validation system</p>
                {% if orders_data.pagesFetched %}
                    <div class="mt-2">
                        <span class="status-indicator info">
                            <i class="fas fa-layers me-1"></i>{{ orders_data.pagesFetched }} pages fetched
                        </span>
                    </div>
                {% endif %}
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end">
                    <small class="text-muted d-block">Last Updated</small>
                    <span class="fw-semibold" id="last-updated">--:--:--</span>
                </div>
                <button class="btn btn-primary btn-icon hover-lift" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

{% if orders_data and orders_data.orders %}
<!-- Statistics Cards -->
<div class="order-stats-grid mb-4">
    <div class="stat-card hover-lift">
        <div class="stat-icon">
            <i class="fas fa-box"></i>
        </div>
        <div class="stat-value">{{ orders_data.orders|length }}</div>
        <div class="stat-label">Total Orders</div>
    </div>

    <div class="stat-card hover-lift">
        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value">{{ orders_data.orders|selectattr('validation_summary')|selectattr('validation_summary.is_valid')|list|length }}</div>
        <div class="stat-label">Validated Orders</div>
    </div>

    <div class="stat-card hover-lift">
        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-value">{{ orders_data.orders|selectattr('validation_summary')|rejectattr('validation_summary.is_valid', 'equalto', true)|list|length }}</div>
        <div class="stat-label">Issues Found</div>
    </div>

    <div class="stat-card hover-lift">
        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger-color);">
            <i class="fas fa-file-slash"></i>
        </div>
        <div class="stat-value">{{ orders_data.orders|rejectattr('has_grn')|list|length }}</div>
        <div class="stat-label">No GRN</div>
    </div>
</div>
{% endif %}

<!-- Improved Horizontal Filters Panel -->
<div class="row mb-4">
    <div class="col-12">
        <div class="filters-panel horizontal-filters">
            <div class="filters-header">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>
                    Filters & Actions
                </h6>
            </div>

            <div class="filters-body horizontal-layout">
                <!-- Date Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Date
                    </label>
                    <form method="GET" class="filter-control">
                        <div class="input-group input-group-sm">
                            <input type="date" name="date" value="{{ selected_date }}" class="form-control">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Search -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-search me-1"></i>
                        Search
                    </label>
                    <div class="filter-control">
                        <div class="input-group input-group-sm">
                            <input type="text" id="orderSearch" placeholder="Search Order ID..." class="form-control">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-filter me-1"></i>
                        Status
                    </label>
                    <div class="filter-control">
                        <select id="issueFilter" class="form-select form-select-sm" onchange="filterByIssues()">
                            <option value="all">All Orders</option>
                            <option value="no-grn">No GRN Available</option>
                            <option value="no-validation">Not Validated</option>
                            <option value="valid">Valid Orders</option>
                            <option value="invalid">Invalid Orders</option>
                            <option value="no-document">No Document</option>
                            <option value="missing-items">Missing Items</option>
                            <option value="extra-items">Extra Items</option>
                            <option value="quantity-issues">Quantity Issues</option>
                            <option value="gtin-issues">GTIN Issues</option>
                        </select>
                    </div>
                </div>

                {% if orders_data and orders_data.orders %}
                <!-- Actions -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-cogs me-1"></i>
                        Actions
                    </label>
                    <div class="filter-control">
                        <div class="btn-group-sm d-flex gap-1">
                            <button class="btn btn-warning" id="validate-all-btn">
                                <i class="fas fa-tasks me-1"></i>
                                Validate All
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if orders_data and orders_data.orders %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Found <strong>{{ orders_data.orders|length }}</strong> completed orders for {{ selected_date }}
            </div>
        </div>
    </div>

    <!-- Orders Grid with Enhanced Layout -->
    <div class="orders-grid">
        {% for order in orders_data.orders %}
            <div class="order-card clickable-card hover-glow slide-in-left" onclick="viewOrderDetail('{{ order.id if order.id else loop.index0 }}', '{{ selected_date }}')" style="animation-delay: {{ (loop.index0 * 0.1)|round(1) }}s">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-box"></i>
                            <div>
                                <h6 class="mb-0">Order #{{ loop.index }}</h6>
                                <small class="opacity-75">{{ order.id }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <i class="fas fa-external-link-alt opacity-75" title="Click to view details"></i>
                    </div>
                </div>

                <div class="card-body order-card-content">
                    <!-- Status Badges -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="status-indicator success">
                            {{ order.orderStatus }}
                        </span>

                        {% if not order.has_grn %}
                            <span class="status-indicator danger" title="No GRN document available for this order">
                                <i class="fas fa-file-slash"></i>No GRN
                            </span>
                        {% endif %}

                        {% if order.validation_summary %}
                            {% if order.validation_summary.has_validation %}
                                {% if order.validation_summary.has_document is defined and order.validation_summary.has_document == false %}
                                    <span class="status-indicator warning" title="No document detected in GRN image">
                                        <i class="fas fa-file-times"></i>No Doc
                                    </span>
                                {% elif order.validation_summary.is_valid %}
                                    <span class="status-indicator success" title="GRN validation passed">
                                        <i class="fas fa-check-circle"></i>Valid
                                    </span>
                                {% else %}
                                    <span class="status-indicator danger" title="GRN validation failed">
                                        <i class="fas fa-exclamation-triangle"></i>{{ order.validation_summary.discrepancies_count }} Issues
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="status-indicator info" title="GRN not validated yet">
                                    <i class="fas fa-question"></i>Unvalidated
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <!-- Enhanced Location Info -->
                    {% if order.location %}
                        <div class="order-meta-section">
                            <h6><i class="fas fa-map-marker-alt"></i>Delivery Location</h6>
                            <div class="order-info-grid">
                                <div class="order-info-item">
                                    <span class="order-info-label">Location:</span>
                                    <span class="order-info-value">{{ order.location.name }}</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="order-info-label">City:</span>
                                    <span class="order-info-value">{{ order.location.address.city or 'N/A' }}</span>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">{{ order.location.address.formattedAddress }}</small>
                        </div>
                    {% endif %}

                    <!-- Enhanced Tour Details -->
                    {% if order.orderMetadata.tourDetail %}
                        {% set tour = order.orderMetadata.tourDetail %}
                        <div class="order-meta-section">
                            <h6><i class="fas fa-truck"></i>Delivery Info</h6>
                            <div class="order-info-grid">
                                <div class="order-info-item">
                                    <span class="order-info-label">Rider:</span>
                                    <span class="order-info-value">{{ tour.riderName }}</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="order-info-label">Vehicle:</span>
                                    <span class="order-info-value">{{ tour.vehicleRegistrationNumber }}</span>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Enhanced Line Items Summary -->
                    {% if order.orderMetadata.lineItems %}
                        <div class="order-meta-section">
                            <h6><i class="fas fa-list"></i>Items ({{ order.orderMetadata.lineItems|length }})</h6>
                            <div class="items-preview">
                                <div class="items-list">
                                    {% for item in order.orderMetadata.lineItems[:3] %}
                                        <div class="item-row">
                                            <span class="item-name">{{ item.id }}</span>
                                            <span class="item-quantity">{{ item.transactionStatus.transactedQuantity }}x</span>
                                        </div>
                                    {% endfor %}
                                    {% if order.orderMetadata.lineItems|length > 3 %}
                                        <div class="text-center mt-2">
                                            <small class="text-muted">+ {{ order.orderMetadata.lineItems|length - 3 }} more items</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Enhanced Validation Summary -->
                    {% if order.validation_summary %}
                        <div class="order-meta-section">
                            <h6><i class="fas fa-clipboard-check"></i>GRN Validation</h6>
                            {% if order.validation_summary.has_validation %}
                                <div class="validation-summary-card">
                                    <div class="validation-progress">
                                        {% if order.validation_summary.is_valid %}
                                            <div class="status-indicator success">
                                                <i class="fas fa-check-circle"></i>Valid
                                            </div>
                                        {% else %}
                                            <div class="status-indicator danger">
                                                <i class="fas fa-exclamation-triangle"></i>Invalid
                                            </div>
                                        {% endif %}
                                        <div class="validation-progress-bar">
                                            <div class="validation-progress-fill" style="width: {{ (order.validation_summary.confidence_score * 100)|round }}%"></div>
                                        </div>
                                        <span class="small text-muted">{{ "%.0f"|format(order.validation_summary.confidence_score * 100) }}%</span>
                                    </div>

                                    {% if order.validation_summary.has_document is defined and order.validation_summary.has_document == false %}
                                        <div class="alert alert-warning alert-sm mb-2">
                                            <i class="fas fa-file-times"></i>No document detected in GRN image
                                        </div>
                                    {% endif %}

                                    <div class="validation-metrics">
                                        <div class="validation-metric">
                                            <div class="validation-metric-value">{{ order.validation_summary.summary.total_items_found or 'N/A' }}</div>
                                            <div class="validation-metric-label">Items</div>
                                        </div>
                                        <div class="validation-metric">
                                            <div class="validation-metric-value">{{ order.validation_summary.discrepancies_count }}</div>
                                            <div class="validation-metric-label">Issues</div>
                                        </div>
                                        {% if order.validation_summary.gtins_verified %}
                                            <div class="validation-metric">
                                                <div class="validation-metric-value">{{ order.validation_summary.gtins_matched }}/{{ order.validation_summary.gtins_verified }}</div>
                                                <div class="validation-metric-label">GTINs</div>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-clock"></i>
                                        Processed {{ order.validation_summary.validation_date.split('T')[0] if order.validation_summary.validation_date else 'N/A' }}
                                        ({{ "%.2f"|format(order.validation_summary.processing_time) }}s)
                                    </small>
                                </div>
                            {% else %}
                                <div class="text-center py-3">
                                    <div class="status-indicator info mb-2">
                                        <i class="fas fa-question"></i>Not Validated
                                    </div>
                                    <small class="text-muted">GRN not processed yet</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    <!-- Enhanced Time Info -->
                    {% if order.orderMetadata.homebaseCompleteOn %}
                        <div class="order-meta-section">
                            <small class="text-muted d-flex align-items-center gap-2">
                                <i class="fas fa-clock"></i>
                                Completed: {{ order.orderMetadata.homebaseCompleteOn.split('T')[0] }}
                                {{ order.orderMetadata.homebaseCompleteOn.split('T')[1].split('.')[0] }}
                            </small>
                        </div>
                    {% endif %}
                </div>

                <!-- Enhanced Card Footer -->
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary btn-icon hover-lift"
                                data-bs-toggle="collapse"
                                data-bs-target="#order-details-{{ loop.index }}"
                                onclick="event.stopPropagation();">
                            <i class="fas fa-eye"></i>
                            Details
                        </button>
                    </div>

                    <div class="action-buttons">
                        {% if not order.has_grn %}
                            <button class="btn btn-sm btn-secondary btn-icon" disabled>
                                <i class="fas fa-file-times"></i>
                                NO GRN Document To Process
                            </button>
                        {% elif order.validation_summary and order.validation_summary.has_validation %}
                            <button class="btn btn-sm btn-warning btn-icon hover-lift reprocess-order-btn"
                                    data-order-id="{{ order.id if order.id else loop.index0 }}"
                                    data-date="{{ selected_date }}"
                                    title="Re-process GRN with AI"
                                    onclick="event.stopPropagation();">
                                <i class="fas fa-redo"></i>
                                Re-process
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-success btn-icon hover-lift validate-order-btn"
                                    data-order-id="{{ order.id if order.id else loop.index0 }}"
                                    data-date="{{ selected_date }}"
                                    title="Validate GRN with AI"
                                    onclick="event.stopPropagation();">
                                <i class="fas fa-check-circle"></i>
                                Validate GRN
                            </button>
                        {% endif %}
                    </div>

                    <div class="validation-status mt-2" id="validation-status-{{ order.id if order.id else loop.index0 }}" style="display: none;">
                        <!-- Validation results will be displayed here -->
                    </div>
                </div>

                <!-- Enhanced Collapsible Details -->
                <div class="collapse" id="order-details-{{ loop.index }}">
                    <div class="border-top bg-light">
                        <div class="p-3">
                            <h6 class="text-gradient mb-3">
                                <i class="fas fa-code"></i>
                                Complete Order Data
                            </h6>
                            <div class="order-details-container">
                                <pre class="order-json">{{ order | tojson(indent=2) }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <!-- Enhanced Empty State -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-inbox"></i>
        </div>
        <h3 class="empty-state-title">No Orders Found</h3>
        <p class="empty-state-description">
            No completed orders found for {{ selected_date }}. Try selecting a different date or check your filters.
        </p>
        <button class="btn btn-primary btn-icon hover-lift mt-3" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
            Refresh Data
        </button>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Function to view order details
function viewOrderDetail(orderId, date) {
    window.location.href = `/order/${orderId}?date=${date}`;
}

// Function to re-process order (force reprocess)
async function reprocessOrder(orderId, date) {
    const statusDiv = document.getElementById(`validation-status-${orderId}`);
    const button = document.querySelector(`[data-order-id="${orderId}"].reprocess-order-btn`);

    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Re-processing...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Re-processing with AI...</div>';

    try {
        const response = await fetch(`/validate-order/${orderId}?date=${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                force_reprocess: true
            })
        });

        const result = await response.json();

        if (result.success) {
            if (result.is_valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success alert-sm">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Re-processed!</strong> GRN validation updated.
                        ${result.cached ? '<small class="text-info">(Previously processed result)</small>' : '<small class="text-success">(Freshly processed)</small>'}
                    </div>
                `;
            } else {
                const discrepancies = result.discrepancies.map(d =>
                    `<li><strong>${d.type}:</strong> ${d.description}</li>`
                ).join('');

                statusDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Re-processed - Issues Found!</strong>
                        ${discrepancies.length > 0 ? `<ul class="mb-0 mt-2">${discrepancies}</ul>` : ''}
                        ${result.confidence_score ? `<small class="text-muted">Confidence: ${Math.round(result.confidence_score * 100)}%</small>` : ''}
                    </div>
                `;
            }

            // Refresh page after 2 seconds to show updated summary
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    <strong>Re-processing Error:</strong> ${result.error || result.message || 'Unknown error occurred'}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger alert-sm">
                <i class="fas fa-times-circle me-1"></i>
                <strong>Error:</strong> Failed to re-process order. Please try again.
            </div>
        `;
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-redo me-1"></i>Re-process';
    }
}

// Function to validate single order
async function validateOrder(orderId, date) {
    const statusDiv = document.getElementById(`validation-status-${orderId}`);
    const button = document.querySelector(`[data-order-id="${orderId}"]`);

    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Validating...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Processing validation...</div>';

    try {
        const response = await fetch(`/validate-order/${orderId}?date=${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            if (result.is_valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success alert-sm">
                        <i class="fas fa-check-circle me-1"></i>
                        <strong>Validated!</strong> GRN matches order data perfectly.
                    </div>
                `;
            } else {
                const discrepancies = result.discrepancies.map(d =>
                    `<li><strong>${d.type}:</strong> ${d.description}</li>`
                ).join('');

                const summary = result.summary || {};
                const fallbackNote = result.fallback ? `<small class="text-info"><i class="fas fa-info-circle me-1"></i>Partial analysis due to processing issues</small><br>` : '';
                const gtinInfo = summary.gtins_verified ? `<br><small class="text-info">GTINs verified: ${summary.gtins_verified}/${summary.gtins_extracted || 0} | Matched: ${summary.gtins_matched || 0}</small>` : '';

                statusDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Validation Failed!</strong>
                        ${fallbackNote}
                        <p class="small mb-1">Found ${summary.total_items_found || 'unknown'} items, expected ${summary.total_items_expected || 'unknown'}. Matched: ${summary.items_matched || 0}</p>
                        ${discrepancies.length > 0 ? `<ul class="mb-0 mt-2">${discrepancies}</ul>` : '<p class="small text-muted">Specific discrepancies could not be determined</p>'}
                        ${result.confidence_score ? `<small class="text-muted">Confidence: ${Math.round(result.confidence_score * 100)}%</small>` : ''}${gtinInfo}
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning alert-sm">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    <strong>Validation Error:</strong> ${result.error || result.message || 'Unknown error occurred'}
                    ${result.ai_response ? `<br><small class="text-muted">AI response was received but could not be processed</small>` : ''}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger alert-sm">
                <i class="fas fa-times-circle me-1"></i>
                <strong>Error:</strong> Failed to validate order. Please try again.
            </div>
        `;
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check-circle me-1"></i>Validate GRN';
    }
}

// Function to validate all orders
async function validateAllOrders() {
    const button = document.getElementById('validate-all-btn');
    const date = '{{ selected_date }}';

    // Ask user for validation mode to optimize API costs
    const validationOptions = [
        "1 - Validate only unvalidated orders (Cost-Effective - Recommended)",
        "2 - Validate all orders (Force reprocess all - Higher API cost)"
    ];

    const modeChoice = prompt(`Choose validation mode to manage Google API costs:\\n\\n${validationOptions.join('\\n')}\\n\\nEnter 1 or 2:`);
    if (!modeChoice || modeChoice === 'cancel') return;

    const validateMode = modeChoice === '2' ? 'all' : 'unvalidated_only';
    const forceReprocess = modeChoice === '2';

    // Get thread count from user (default 20)
    const threadCount = prompt('Enter number of threads for parallel processing (1-50):', '20');
    if (!threadCount || threadCount === 'cancel') return;

    const maxWorkers = Math.min(Math.max(parseInt(threadCount) || 20, 1), 50);

    // Show loading state with mode info
    const modeText = validateMode === 'all' ? 'All Orders' : 'Unvalidated Only (Cost-Optimized)';
    button.disabled = true;
    button.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Validating ${modeText} (${maxWorkers} threads)...`;

    try {
        const response = await fetch(`/validate-all-orders?date=${date}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                max_workers: maxWorkers,
                validate_mode: validateMode,
                force_reprocess: forceReprocess
            })
        });

        const result = await response.json();

        if (result.success) {
            // Update individual order status displays
            result.results.forEach(orderResult => {
                const statusDiv = document.getElementById(`validation-status-${orderResult.order_id}`);
                if (statusDiv) {
                    statusDiv.style.display = 'block';

                    if (orderResult.is_valid) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success alert-sm">
                                <i class="fas fa-check-circle me-1"></i>
                                <strong>Validated!</strong> GRN matches order data.
                            </div>
                        `;
                    } else if (orderResult.discrepancies) {
                        const discrepancies = orderResult.discrepancies.map(d =>
                            `<li><strong>${d.type}:</strong> ${d.description}</li>`
                        ).join('');

                        statusDiv.innerHTML = `
                            <div class="alert alert-danger alert-sm">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Issues Found!</strong>
                                <ul class="mb-0 mt-2">${discrepancies}</ul>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-warning alert-sm">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                <strong>Validation Error:</strong> ${orderResult.message || 'Unknown error'}
                            </div>
                        `;
                    }
                }
            });

            // Show summary with cost optimization info
            const validCount = result.results.filter(r => r.is_valid).length;
            const totalCount = result.results.length;
            const threadsUsed = result.threads_used || maxWorkers;
            const apiCalls = result.api_calls_made || 0;
            const cachedResults = result.cached_results || 0;
            const skippedOrders = result.skipped || 0;
            const ordersWithoutGrn = result.orders_without_grn || 0;
            const ordersWithGrn = result.orders_with_grn || 0;

            let summaryMessage = `Batch validation completed!\n‚úÖ Valid orders: ${validCount}/${totalCount}\n‚ùå Invalid orders: ${totalCount - validCount}`;

            if (ordersWithoutGrn > 0) {
                summaryMessage += `\n\nüìÑ GRN Status:\n‚úÖ Orders with GRN: ${ordersWithGrn}\n‚ùå Orders without GRN: ${ordersWithoutGrn} (excluded from validation)`;
            }

            if (result.validate_mode === 'unvalidated_only' || apiCalls < result.total_orders) {
                summaryMessage += `\n\nüí∞ Cost Optimization:\nüìû API calls made: ${apiCalls}\nüíæ From cache: ${cachedResults}\n‚è≠Ô∏è Skipped (already validated): ${skippedOrders}`;
            }

            summaryMessage += `\n\nüßµ Threads used: ${threadsUsed}\n‚ö° Mode: ${result.validate_mode === 'all' ? 'All Orders' : 'Unvalidated Only'}`;

            if (result.message) {
                summaryMessage = result.message + '\n\n' + summaryMessage;
            }

            alert(summaryMessage);
        } else {
            alert(`Batch validation failed: ${result.message}`);
        }
    } catch (error) {
        alert('Error during batch validation. Please try again.');
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-tasks me-1"></i>Validate All Orders';
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Individual validation buttons
    document.querySelectorAll('.validate-order-btn').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const date = this.getAttribute('data-date');
            validateOrder(orderId, date);
        });
    });

    // Re-process buttons
    document.querySelectorAll('.reprocess-order-btn').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            const date = this.getAttribute('data-date');
            reprocessOrder(orderId, date);
        });
    });

    // Batch validation button
    const validateAllBtn = document.getElementById('validate-all-btn');
    if (validateAllBtn) {
        validateAllBtn.addEventListener('click', validateAllOrders);
    }

    // Initialize order search functionality
    setupOrderSearch();
});

// Auto-refresh disabled - users can manually refresh when needed
// Uncomment the following lines if you want auto-refresh every 5 minutes:
// setInterval(function() {
//     if (!document.querySelector('.collapse.show') && !document.querySelector('button:disabled')) {
//         location.reload();
//     }
// }, 300000); // 5 minutes instead of 30 seconds

// Order ID search functionality
function setupOrderSearch() {
    const searchInput = document.getElementById('orderSearch');
    const orderCards = document.querySelectorAll('.order-card');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();

            orderCards.forEach(card => {
                const orderIdBadge = card.querySelector('.badge.bg-primary');
                const orderHeader = card.querySelector('.card-header h6');

                if (searchTerm === '') {
                    // Show all cards when search is empty
                    card.parentElement.style.display = 'block';
                } else {
                    // Check if search term matches order ID or order number
                    let matches = false;

                    if (orderIdBadge) {
                        const orderId = orderIdBadge.textContent.toLowerCase();
                        if (orderId.includes(searchTerm)) {
                            matches = true;
                        }
                    }

                    if (orderHeader) {
                        const headerText = orderHeader.textContent.toLowerCase();
                        if (headerText.includes(searchTerm)) {
                            matches = true;
                        }
                    }

                    // Show/hide card based on match
                    card.parentElement.style.display = matches ? 'block' : 'none';
                }
            });
        });
    }
}

function clearSearch() {
    const searchInput = document.getElementById('orderSearch');
    const issueFilter = document.getElementById('issueFilter');
    const orderCards = document.querySelectorAll('.order-card');

    if (searchInput) {
        searchInput.value = '';
    }
    if (issueFilter) {
        issueFilter.value = 'all';
    }

    // Show all cards
    orderCards.forEach(card => {
        card.parentElement.style.display = 'block';
        card.parentElement.classList.remove('filtered-out');
    });
}

function filterByIssues() {
    const filterValue = document.getElementById('issueFilter').value;
    const orderCards = document.querySelectorAll('.order-card');
    let visibleCount = 0;

    orderCards.forEach(card => {
        const cardContainer = card.parentElement;
        let shouldShow = false;

        // Get validation badges from the card
        const validBadge = card.querySelector('.badge:contains("Valid")') || card.querySelector('.badge .fa-check-circle');
        const issuesBadge = card.querySelector('.badge:contains("Issues")') || card.querySelector('.badge .fa-exclamation-triangle');
        const noDocBadge = card.querySelector('.badge:contains("No Doc")') || card.querySelector('.badge .fa-file-times');
        const noGrnBadge = card.querySelector('.badge:contains("No GRN")') || card.querySelector('.badge .fa-file-slash');
        const unvalidatedBadge = card.querySelector('.badge:contains("Unvalidated")') || card.querySelector('.badge .fa-question');
        const missingItemsBadge = card.querySelector('.badge .fa-minus-circle');
        const extraItemsBadge = card.querySelector('.badge .fa-plus-circle');

        // Parse validation summary for more detailed filtering
        const validationSummary = card.querySelector('.validation-summary-card');
        let hasQuantityIssues = false;
        let hasGtinIssues = false;

        if (validationSummary) {
            const summaryText = validationSummary.textContent.toLowerCase();
            hasQuantityIssues = summaryText.includes('quantity') || summaryText.includes('mismatch');
            hasGtinIssues = summaryText.includes('gtin') || summaryText.includes('barcode');
        }

        // Apply filter logic
        switch (filterValue) {
            case 'all':
                shouldShow = true;
                break;
            case 'no-grn':
                shouldShow = noGrnBadge !== null;
                break;
            case 'no-validation':
                shouldShow = unvalidatedBadge !== null;
                break;
            case 'valid':
                shouldShow = validBadge !== null;
                break;
            case 'invalid':
                shouldShow = issuesBadge !== null;
                break;
            case 'no-document':
                shouldShow = noDocBadge !== null;
                break;
            case 'missing-items':
                shouldShow = missingItemsBadge !== null;
                break;
            case 'extra-items':
                shouldShow = extraItemsBadge !== null;
                break;
            case 'quantity-issues':
                shouldShow = hasQuantityIssues;
                break;
            case 'gtin-issues':
                shouldShow = hasGtinIssues;
                break;
        }

        // Show/hide based on filter
        if (shouldShow) {
            cardContainer.style.display = 'block';
            cardContainer.classList.remove('filtered-out');
            visibleCount++;
        } else {
            cardContainer.style.display = 'none';
            cardContainer.classList.add('filtered-out');
        }
    });

    // Update filter count indicator
    updateFilterCount(visibleCount, orderCards.length, filterValue);
}

function updateFilterCount(visible, total, filterType) {
    // Remove existing filter count indicator
    const existingIndicator = document.querySelector('.filter-count-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }

    if (filterType !== 'all' && visible < total) {
        // Add new filter count indicator
        const indicator = document.createElement('div');
        indicator.className = 'alert alert-info filter-count-indicator mt-2';
        indicator.innerHTML = `
            <i class="fas fa-filter me-2"></i>
            Showing <strong>${visible}</strong> of <strong>${total}</strong> orders matching filter: <strong>${getFilterDisplayName(filterType)}</strong>
            <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="clearFilters()">
                <i class="fas fa-times"></i> Clear Filter
            </button>
        `;

        // Insert after the main info alert
        const infoAlert = document.querySelector('.alert.alert-info');
        if (infoAlert) {
            infoAlert.parentNode.insertBefore(indicator, infoAlert.nextSibling);
        }
    }
}

function getFilterDisplayName(filterValue) {
    const filterNames = {
        'no-grn': 'No GRN Available',
        'no-validation': 'Not Validated',
        'valid': 'Valid Orders',
        'invalid': 'Invalid Orders',
        'no-document': 'No Document',
        'missing-items': 'Missing Items',
        'extra-items': 'Extra Items',
        'quantity-issues': 'Quantity Issues',
        'gtin-issues': 'GTIN Issues'
    };
    return filterNames[filterValue] || filterValue;
}

function clearFilters() {
    document.getElementById('issueFilter').value = 'all';
    filterByIssues();
}

// Format JSON in details
document.querySelectorAll('.order-json').forEach(function(element) {
    try {
        const json = JSON.parse(element.textContent);
        element.textContent = JSON.stringify(json, null, 2);
    } catch (e) {
        // Already formatted
    }
});
</script>
{% endblock %}